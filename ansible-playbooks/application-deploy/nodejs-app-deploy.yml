---
# ⚠️ 教学声明：本 playbook 主要用于学习 Node.js 应用部署，请在测试环境验证后再应用于生产。
- name: Node.js 应用服务部署
  hosts: nodejs_servers
  gather_facts: true
  become: yes
  vars_files:
    - vars/default.yml

  handlers:
    - name: 重启 Node.js 应用（systemd）
      ansible.builtin.service:
        name: "{{ nodejs_app_name }}"
        state: restarted

    - name: 重新加载 systemd 守护进程
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: 重启 PM2 服务
      ansible.builtin.command: "pm2 restart {{ nodejs_pm2_app_name }}"
      become_user: "{{ nodejs_app_user }}"
      register: pm2_restart
      changed_when: "'restart' in pm2_restart.stdout"

  tasks:
    - name: 更新 APT 包缓存
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      tags: [nodejs, packages]

    - name: 安装 Node.js 依赖
      ansible.builtin.package:
        name:
          - curl
          - wget
          - gnupg
          - ca-certificates
          - build-essential
          - git
        state: present
      tags: [nodejs, packages]

    - name: 添加 NodeSource APT 仓库密钥
      ansible.builtin.apt_key:
        url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
        state: present
      tags: [nodejs, packages]

    - name: 添加 NodeSource APT 仓库
      ansible.builtin.apt_repository:
        repo: "deb https://deb.nodesource.com/node_{{ nodejs_version }}.x {{ ansible_distribution_release }} main"
        state: present
        update_cache: yes
      tags: [nodejs, packages]

    - name: 安装 Node.js
      ansible.builtin.package:
        name: nodejs
        state: present
      tags: [nodejs, packages]

    - name: 验证 Node.js 安装
      ansible.builtin.command: node --version
      register: node_version
      changed_when: false
      tags: [nodejs, verify]

    - name: 验证 npm 安装
      ansible.builtin.command: npm --version
      register: npm_version
      changed_when: false
      tags: [nodejs, verify]

    - name: 创建 Node.js 应用用户
      ansible.builtin.user:
        name: "{{ nodejs_app_user }}"
        group: "{{ nodejs_app_group }}"
        shell: /bin/bash
        home: "/home/{{ nodejs_app_user }}"
        create_home: yes
        system: yes
        state: present
      tags: [nodejs, user]

    - name: 创建应用目录
      ansible.builtin.file:
        path: "{{ nodejs_app_path }}"
        state: directory
        owner: "{{ nodejs_app_user }}"
        group: "{{ nodejs_app_group }}"
        mode: '0755'
      tags: [nodejs, directories]

    - name: 创建日志目录
      ansible.builtin.file:
        path: "/var/log/{{ nodejs_app_name }}"
        state: directory
        owner: "{{ nodejs_app_user }}"
        group: "{{ nodejs_app_group }}"
        mode: '0755'
      tags: [nodejs, directories]

    - name: 从 Git 仓库克隆应用代码
      ansible.builtin.git:
        repo: "{{ nodejs_git_repo }}"
        dest: "{{ nodejs_app_path }}"
        version: "{{ nodejs_git_branch }}"
        force: yes
      become_user: "{{ nodejs_app_user }}"
      when: nodejs_git_repo != ""
      tags: [nodejs, code]

    - name: 创建示例 Node.js 应用（当没有 Git 仓库时）
      ansible.builtin.copy:
        dest: "{{ nodejs_app_path }}/package.json"
        content: |
          {
            "name": "{{ nodejs_app_name }}",
            "version": "1.0.0",
            "description": "示例 Node.js 应用",
            "main": "app.js",
            "scripts": {
              "start": "node app.js",
              "dev": "node app.js",
              "test": "echo \"Error: no test specified\" && exit 1"
            },
            "keywords": ["nodejs", "example"],
            "author": "Ansible",
            "license": "MIT",
            "dependencies": {
              "express": "^4.18.2"
            }
          }
        owner: "{{ nodejs_app_user }}"
        group: "{{ nodejs_app_group }}"
        mode: '0644'
      when: nodejs_git_repo == ""
      tags: [nodejs, code]

    - name: 创建示例应用文件
      ansible.builtin.copy:
        dest: "{{ nodejs_app_path }}/app.js"
        content: |
          const express = require('express');
          const app = express();
          const port = {{ nodejs_app_port }};
          
          // 基础中间件
          app.use(express.json());
          app.use(express.urlencoded({ extended: true }));
          
          // 健康检查端点
          app.get('/health', (req, res) => {
            res.status(200).json({
              status: 'healthy',
              timestamp: new Date().toISOString(),
              uptime: process.uptime(),
              app: '{{ nodejs_app_name }}'
            });
          });
          
          // 主页
          app.get('/', (req, res) => {
            res.json({
              message: 'Hello from {{ nodejs_app_name }}!',
              environment: '{{ nodejs_app_environment }}',
              timestamp: new Date().toISOString(),
              nodeVersion: process.version
            });
          });
          
          // API 端点
          app.get('/api/info', (req, res) => {
            res.json({
              app: '{{ nodejs_app_name }}',
              environment: '{{ nodejs_app_environment }}',
              port: {{ nodejs_app_port }},
              nodeVersion: process.version,
              platform: process.platform,
              arch: process.arch,
              pid: process.pid
            });
          });
          
          // 错误处理中间件
          app.use((err, req, res, next) => {
            console.error(err.stack);
            res.status(500).json({ error: 'Something went wrong!' });
          });
          
          // 404 处理
          app.use((req, res) => {
            res.status(404).json({ error: 'Not Found' });
          });
          
          // 启动服务器
          app.listen(port, '0.0.0.0', () => {
            console.log(`{{ nodejs_app_name }} server running on port ${port}`);
            console.log(`Environment: {{ nodejs_app_environment }}`);
            console.log(`PID: ${process.pid}`);
          });
          
          // 优雅关闭处理
          process.on('SIGTERM', () => {
            console.log('SIGTERM received, shutting down gracefully');
            process.exit(0);
          });
          
          process.on('SIGINT', () => {
            console.log('SIGINT received, shutting down gracefully');
            process.exit(0);
          });
        owner: "{{ nodejs_app_user }}"
        group: "{{ nodejs_app_group }}"
        mode: '0644'
      when: nodejs_git_repo == ""
      tags: [nodejs, code]

    - name: 安装 Node.js 应用依赖
      ansible.builtin.npm:
        path: "{{ nodejs_app_path }}"
        state: present
        production: true
      become_user: "{{ nodejs_app_user }}"
      retries: "{{ app_retry_count }}"
      delay: "{{ app_retry_delay }}"
      register: npm_install
      tags: [nodejs, dependencies]

    - name: 安装 PM2（进程管理器）
      ansible.builtin.npm:
        name: pm2
        global: yes
        state: present
      when: nodejs_use_pm2
      tags: [nodejs, pm2]

    - name: 创建 PM2 配置文件
      ansible.builtin.template:
        src: templates/ecosystem.config.js.j2
        dest: "{{ nodejs_app_path }}/ecosystem.config.js"
        owner: "{{ nodejs_app_user }}"
        group: "{{ nodejs_app_group }}"
        mode: '0644'
      when: nodejs_use_pm2
      tags: [nodejs, pm2]

    - name: 使用 PM2 启动应用
      ansible.builtin.command: "pm2 start {{ nodejs_app_path }}/ecosystem.config.js"
      become_user: "{{ nodejs_app_user }}"
      when: nodejs_use_pm2
      register: pm2_start
      changed_when: "'started' in pm2_start.stdout"
      tags: [nodejs, pm2]

    - name: 保存 PM2 进程列表
      ansible.builtin.command: "pm2 save"
      become_user: "{{ nodejs_app_user }}"
      when: nodejs_use_pm2
      tags: [nodejs, pm2]

    - name: 创建 systemd 服务文件
      ansible.builtin.template:
        src: templates/nodejs.service.j2
        dest: "/etc/systemd/system/{{ nodejs_app_name }}.service"
        owner: root
        group: root
        mode: '0644'
      when: nodejs_systemd_service and not nodejs_use_pm2
      notify: 重新加载 systemd 守护进程
      tags: [nodejs, systemd]

    - name: 启动并启用 Node.js systemd 服务
      ansible.builtin.service:
        name: "{{ nodejs_app_name }}"
        state: started
        enabled: yes
      when: nodejs_systemd_service and not nodejs_use_pm2
      tags: [nodejs, systemd]

    - name: 等待 Node.js 应用端口就绪
      ansible.builtin.wait_for:
        port: "{{ nodejs_app_port }}"
        delay: 5
        timeout: 60
        state: started
      tags: [nodejs, verify]

    - name: 验证 Node.js 应用健康状态
      ansible.builtin.uri:
        url: "http://localhost:{{ nodejs_app_port }}/health"
        method: GET
        status_code: 200
        return_content: yes
      register: health_check
      retries: "{{ app_retry_count }}"
      delay: "{{ app_retry_delay }}"
      tags: [nodejs, verify]

    - name: 验证应用主页
      ansible.builtin.uri:
        url: "http://localhost:{{ nodejs_app_port }}"
        method: GET
        status_code: 200
        return_content: yes
      register: home_check
      retries: "{{ app_retry_count }}"
      delay: "{{ app_retry_delay }}"
      tags: [nodejs, verify]

    - name: 配置防火墙规则（开放应用端口）
      community.general.ufw:
        rule: allow
        port: "{{ nodejs_app_port }}"
        proto: tcp
      when: app_firewall_enabled and ansible_os_family == "Debian"
      tags: [nodejs, firewall]

    - name: 输出 Node.js 应用部署结果
      ansible.builtin.debug:
        msg:
          - "Node.js 应用部署完成！"
          - "应用名称: {{ nodejs_app_name }}"
          - "Node.js 版本: {{ node_version.stdout }}"
          - "npm 版本: {{ npm_version.stdout }}"
          - "应用路径: {{ nodejs_app_path }}"
          - "运行用户: {{ nodejs_app_user }}"
          - "监听端口: {{ nodejs_app_port }}"
          - "运行环境: {{ nodejs_app_environment }}"
          - "进程管理: {% if nodejs_use_pm2 %}PM2{% else %}systemd{% endif %}"
          - "访问地址: http://localhost:{{ nodejs_app_port }}"
          - "健康检查: http://localhost:{{ nodejs_app_port }}/health"
          - "API 信息: http://localhost:{{ nodejs_app_port }}/api/info"
      tags: [nodejs, info]
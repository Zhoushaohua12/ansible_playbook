<?php
/**
 * æ•°æ®åº“è¿æ¥æµ‹è¯•é¡µé¢
 * âš ï¸ æ•™å­¦å£°æ˜ï¼šæ­¤é¡µé¢ä¸»è¦ç”¨äºæµ‹è¯•æ•°æ®åº“è¿æ¥ï¼Œç”Ÿäº§ç¯å¢ƒè¯·åˆ é™¤æˆ–é™åˆ¶è®¿é—®
 */

// æ•°æ®åº“é…ç½®
$db_host = 'localhost';
$db_name = '{{ lamp_mysql_database }}';
$db_user = '{{ lamp_mysql_user }}';
$db_pass = '{{ lamp_mysql_password }}';

// å­—ç¬¦ç¼–ç 
header('Content-Type: text/html; charset=utf-8');

?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“è¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007cba; padding-bottom: 10px; }
        .success { color: #28a745; background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .error { color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .info { color: #17a2b8; background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .warning { color: #856404; background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” LAMP æ ˆæ•°æ®åº“è¿æ¥æµ‹è¯•</h1>
        
        <?php
        try {
            // åˆ›å»º PDO è¿æ¥
            $pdo = new PDO("mysql:host=$db_host;dbname=$db_name;charset=utf8mb4", $db_user, $db_pass);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            
            echo '<div class="success">âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼</div>';
            
            // æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
            echo '<h2>ğŸ“Š è¿æ¥ä¿¡æ¯</h2>';
            echo '<table>';
            echo '<tr><th>é…ç½®é¡¹</th><th>å€¼</th></tr>';
            echo '<tr><td>æ•°æ®åº“ä¸»æœº</td><td>' . htmlspecialchars($db_host) . '</td></tr>';
            echo '<tr><td>æ•°æ®åº“åç§°</td><td>' . htmlspecialchars($db_name) . '</td></tr>';
            echo '<tr><td>ç”¨æˆ·å</td><td>' . htmlspecialchars($db_user) . '</td></tr>';
            echo '<tr><td>å­—ç¬¦é›†</td><td>utf8mb4</td></tr>';
            echo '</table>';
            
            // è·å– MySQL ç‰ˆæœ¬ä¿¡æ¯
            $version = $pdo->query("SELECT VERSION() as version")->fetch(PDO::FETCH_ASSOC);
            echo '<h2>ğŸ”§ æ•°æ®åº“ä¿¡æ¯</h2>';
            echo '<table>';
            echo '<tr><th>å±æ€§</th><th>å€¼</th></tr>';
            echo '<tr><td>MySQL ç‰ˆæœ¬</td><td>' . htmlspecialchars($version['version']) . '</td></tr>';
            echo '<tr><td>PDO é©±åŠ¨</td><td>' . htmlspecialchars($pdo->getAttribute(PDO::ATTR_DRIVER_NAME)) . '</td></tr>';
            echo '</table>';
            
            // æµ‹è¯•åŸºæœ¬æŸ¥è¯¢
            echo '<h2>ğŸ§ª åŸºæœ¬æŸ¥è¯¢æµ‹è¯•</h2>';
            $tables = $pdo->query("SHOW TABLES")->fetchAll(PDO::FETCH_COLUMN);
            if (count($tables) > 0) {
                echo '<div class="info">ğŸ“‹ æ•°æ®åº“ä¸­çš„è¡¨ï¼š</div>';
                echo '<ul>';
                foreach ($tables as $table) {
                    echo '<li>' . htmlspecialchars($table) . '</li>';
                }
                echo '</ul>';
            } else {
                echo '<div class="warning">âš ï¸ æ•°æ®åº“ä¸­æš‚æ— è¡¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„åˆå§‹çŠ¶æ€ã€‚</div>';
            }
            
            // åˆ›å»ºæµ‹è¯•è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            $pdo->exec("CREATE TABLE IF NOT EXISTS test_connection (
                id INT AUTO_INCREMENT PRIMARY KEY,
                message VARCHAR(255) NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");
            
            // æ’å…¥æµ‹è¯•æ•°æ®
            $stmt = $pdo->prepare("INSERT INTO test_connection (message) VALUES (:message)");
            $stmt->execute(['message' => 'LAMP æ ˆè¿æ¥æµ‹è¯• - ' . date('Y-m-d H:i:s')]);
            
            // æŸ¥è¯¢æµ‹è¯•æ•°æ®
            $test_data = $pdo->query("SELECT * FROM test_connection ORDER BY created_at DESC LIMIT 5")->fetchAll(PDO::FETCH_ASSOC);
            
            if (count($test_data) > 0) {
                echo '<h2>ğŸ“ æµ‹è¯•æ•°æ®è®°å½•ï¼ˆæœ€è¿‘5æ¡ï¼‰</h2>';
                echo '<table>';
                echo '<tr><th>ID</th><th>æ¶ˆæ¯</th><th>åˆ›å»ºæ—¶é—´</th></tr>';
                foreach ($test_data as $row) {
                    echo '<tr>';
                    echo '<td>' . htmlspecialchars($row['id']) . '</td>';
                    echo '<td>' . htmlspecialchars($row['message']) . '</td>';
                    echo '<td>' . htmlspecialchars($row['created_at']) . '</td>';
                    echo '</tr>';
                }
                echo '</table>';
            }
            
        } catch (PDOException $e) {
            echo '<div class="error">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼</div>';
            echo '<div class="error"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ' . htmlspecialchars($e->getMessage()) . '</div>';
            echo '<div class="info"><strong>æ’æŸ¥å»ºè®®ï¼š</strong></div>';
            echo '<ul>';
            echo '<li>æ£€æŸ¥ MySQL æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ</li>';
            echo '<li>éªŒè¯æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®</li>';
            echo '<li>ç¡®è®¤æ•°æ®åº“æ˜¯å¦å­˜åœ¨</li>';
            echo '<li>æ£€æŸ¥ç”¨æˆ·æƒé™è®¾ç½®</li>';
            echo '</ul>';
        }
        
        // æ˜¾ç¤º PHP ä¿¡æ¯
        echo '<h2>âš™ï¸ PHP ç¯å¢ƒä¿¡æ¯</h2>';
        echo '<table>';
        echo '<tr><th>é…ç½®é¡¹</th><th>å€¼</th></tr>';
        echo '<tr><td>PHP ç‰ˆæœ¬</td><td>' . htmlspecialchars(PHP_VERSION) . '</td></tr>';
        echo '<tr><td>æœåŠ¡å™¨è½¯ä»¶</td><td>' . htmlspecialchars($_SERVER['SERVER_SOFTWARE'] ?? 'æœªçŸ¥') . '</td></tr>';
        echo '<tr><td>æ–‡æ¡£æ ¹ç›®å½•</td><td>' . htmlspecialchars($_SERVER['DOCUMENT_ROOT'] ?? 'æœªçŸ¥') . '</td></tr>';
        echo '<tr><td>å†…å­˜é™åˆ¶</td><td>' . htmlspecialchars(ini_get('memory_limit')) . '</td></tr>';
        echo '<tr><td>ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶</td><td>' . htmlspecialchars(ini_get('upload_max_filesize')) . '</td></tr>';
        echo '</table>';
        ?>
        
        <div class="warning">
            <strong>âš ï¸ å®‰å…¨æé†’ï¼š</strong>
            <ul>
                <li>æ­¤æµ‹è¯•é¡µé¢åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸­è¯·åŠ¡å¿…åˆ é™¤æˆ–é™åˆ¶è®¿é—®æƒé™</li>
                <li>å»ºè®®ä½¿ç”¨ IP ç™½åå•æˆ–åŸºæœ¬è®¤è¯æ¥ä¿æŠ¤æ­¤é¡µé¢</li>
                <li>å®šæœŸæ£€æŸ¥å’Œæ›´æ–°æ•°æ®åº“å¯†ç </li>
                <li>å¯ç”¨æ•°æ®åº“è¿æ¥çš„ SSL/TLS åŠ å¯†</li>
            </ul>
        </div>
        
        <p><strong>æµ‹è¯•å®Œæˆæ—¶é—´ï¼š</strong> <?php echo date('Y-m-d H:i:s'); ?></p>
    </div>
</body>
</html>
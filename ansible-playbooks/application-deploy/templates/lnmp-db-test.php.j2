<?php
/**
 * LNMP æ ˆæ•°æ®åº“è¿æ¥æµ‹è¯•é¡µé¢
 * âš ï¸ æ•™å­¦å£°æ˜ï¼šæ­¤é¡µé¢ä¸»è¦ç”¨äºæµ‹è¯•æ•°æ®åº“è¿æ¥ï¼Œç”Ÿäº§ç¯å¢ƒè¯·åˆ é™¤æˆ–é™åˆ¶è®¿é—®
 */

// æ•°æ®åº“é…ç½®
$db_host = 'localhost';
$db_name = '{{ lnmp_mysql_database }}';
$db_user = '{{ lnmp_mysql_user }}';
$db_pass = '{{ lnmp_mysql_password }}';

// å­—ç¬¦ç¼–ç 
header('Content-Type: text/html; charset=utf-8');

?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LNMP æ ˆæ•°æ®åº“è¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #009688; padding-bottom: 10px; }
        .success { color: #28a745; background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .error { color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .info { color: #17a2b8; background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .warning { color: #856404; background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .nginx-info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .php-info { background: #f3e5f5; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” LNMP æ ˆæ•°æ®åº“è¿æ¥æµ‹è¯•</h1>
        
        <?php
        try {
            // åˆ›å»º PDO è¿æ¥
            $pdo = new PDO("mysql:host=$db_host;dbname=$db_name;charset=utf8mb4", $db_user, $db_pass);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            
            echo '<div class="success">âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼</div>';
            
            // æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
            echo '<h2>ğŸ“Š æ•°æ®åº“è¿æ¥ä¿¡æ¯</h2>';
            echo '<table>';
            echo '<tr><th>é…ç½®é¡¹</th><th>å€¼</th></tr>';
            echo '<tr><td>æ•°æ®åº“ä¸»æœº</td><td>' . htmlspecialchars($db_host) . '</td></tr>';
            echo '<tr><td>æ•°æ®åº“åç§°</td><td>' . htmlspecialchars($db_name) . '</td></tr>';
            echo '<tr><td>ç”¨æˆ·å</td><td>' . htmlspecialchars($db_user) . '</td></tr>';
            echo '<tr><td>å­—ç¬¦é›†</td><td>utf8mb4</td></tr>';
            echo '</table>';
            
            // è·å– MySQL ç‰ˆæœ¬ä¿¡æ¯
            $version = $pdo->query("SELECT VERSION() as version")->fetch(PDO::FETCH_ASSOC);
            echo '<h2>ğŸ”§ æ•°æ®åº“æœåŠ¡å™¨ä¿¡æ¯</h2>';
            echo '<table>';
            echo '<tr><th>å±æ€§</th><th>å€¼</th></tr>';
            echo '<tr><td>MySQL ç‰ˆæœ¬</td><td>' . htmlspecialchars($version['version']) . '</td></tr>';
            echo '<tr><td>PDO é©±åŠ¨</td><td>' . htmlspecialchars($pdo->getAttribute(PDO::ATTR_DRIVER_NAME)) . '</td></tr>';
            echo '<tr><td>è¿æ¥çŠ¶æ€</td><td><span class="status status-ok">æ­£å¸¸</span></td></tr>';
            echo '</table>';
            
            // æµ‹è¯•åŸºæœ¬æŸ¥è¯¢
            echo '<h2>ğŸ§ª æ•°æ®åº“æŸ¥è¯¢æµ‹è¯•</h2>';
            $tables = $pdo->query("SHOW TABLES")->fetchAll(PDO::FETCH_COLUMN);
            if (count($tables) > 0) {
                echo '<div class="info">ğŸ“‹ æ•°æ®åº“ä¸­çš„è¡¨ï¼š</div>';
                echo '<table>';
                echo '<tr><th>è¡¨å</th><th>è®°å½•æ•°</th></tr>';
                foreach ($tables as $table) {
                    $count = $pdo->query("SELECT COUNT(*) as cnt FROM `$table`")->fetch(PDO::FETCH_ASSOC);
                    echo '<tr><td>' . htmlspecialchars($table) . '</td><td>' . htmlspecialchars($count['cnt']) . '</td></tr>';
                }
                echo '</table>';
            } else {
                echo '<div class="warning">âš ï¸ æ•°æ®åº“ä¸­æš‚æ— è¡¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„åˆå§‹çŠ¶æ€ã€‚</div>';
            }
            
            // åˆ›å»ºæµ‹è¯•è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            $pdo->exec("CREATE TABLE IF NOT EXISTS lnmp_test_connection (
                id INT AUTO_INCREMENT PRIMARY KEY,
                message VARCHAR(255) NOT NULL,
                server_info VARCHAR(255),
                php_version VARCHAR(50),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");
            
            // æ’å…¥æµ‹è¯•æ•°æ®
            $stmt = $pdo->prepare("INSERT INTO lnmp_test_connection (message, server_info, php_version) VALUES (:message, :server_info, :php_version)");
            $stmt->execute([
                'message' => 'LNMP æ ˆè¿æ¥æµ‹è¯• - ' . date('Y-m-d H:i:s'),
                'server_info' => ($_SERVER['SERVER_SOFTWARE'] ?? 'æœªçŸ¥'),
                'php_version' => PHP_VERSION
            ]);
            
            // æŸ¥è¯¢æµ‹è¯•æ•°æ®
            $test_data = $pdo->query("SELECT * FROM lnmp_test_connection ORDER BY created_at DESC LIMIT 5")->fetchAll(PDO::FETCH_ASSOC);
            
            if (count($test_data) > 0) {
                echo '<h2>ğŸ“ æµ‹è¯•æ•°æ®è®°å½•ï¼ˆæœ€è¿‘5æ¡ï¼‰</h2>';
                echo '<table>';
                echo '<tr><th>ID</th><th>æ¶ˆæ¯</th><th>æœåŠ¡å™¨ä¿¡æ¯</th><th>PHPç‰ˆæœ¬</th><th>åˆ›å»ºæ—¶é—´</th></tr>';
                foreach ($test_data as $row) {
                    echo '<tr>';
                    echo '<td>' . htmlspecialchars($row['id']) . '</td>';
                    echo '<td>' . htmlspecialchars($row['message']) . '</td>';
                    echo '<td>' . htmlspecialchars($row['server_info']) . '</td>';
                    echo '<td>' . htmlspecialchars($row['php_version']) . '</td>';
                    echo '<td>' . htmlspecialchars($row['created_at']) . '</td>';
                    echo '</tr>';
                }
                echo '</table>';
            }
            
        } catch (PDOException $e) {
            echo '<div class="error">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼</div>';
            echo '<div class="error"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ' . htmlspecialchars($e->getMessage()) . '</div>';
            echo '<div class="info"><strong>æ’æŸ¥å»ºè®®ï¼š</strong></div>';
            echo '<ul>';
            echo '<li>æ£€æŸ¥ MySQL æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ</li>';
            echo '<li>éªŒè¯æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®</li>';
            echo '<li>ç¡®è®¤æ•°æ®åº“æ˜¯å¦å­˜åœ¨</li>';
            echo '<li>æ£€æŸ¥ç”¨æˆ·æƒé™è®¾ç½®</li>';
            echo '<li>ç¡®è®¤ PHP-FPM å’Œ Nginx é…ç½®æ­£ç¡®</li>';
            echo '</ul>';
        }
        ?>
        
        <div class="nginx-info">
            <h3>ğŸŒ Nginx æœåŠ¡å™¨ä¿¡æ¯</h3>
            <table>
                <tr><th>é…ç½®é¡¹</th><th>å€¼</th></tr>
                <tr><td>æœåŠ¡å™¨è½¯ä»¶</td><td><?php echo htmlspecialchars($_SERVER['SERVER_SOFTWARE'] ?? 'æœªçŸ¥'); ?></td></tr>
                <tr><td>æœåŠ¡å™¨åç§°</td><td><?php echo htmlspecialchars($_SERVER['SERVER_NAME'] ?? 'æœªçŸ¥'); ?></td></tr>
                <tr><td>æ–‡æ¡£æ ¹ç›®å½•</td><td><?php echo htmlspecialchars($_SERVER['DOCUMENT_ROOT'] ?? 'æœªçŸ¥'); ?></td></tr>
                <tr><td>è¯·æ±‚URI</td><td><?php echo htmlspecialchars($_SERVER['REQUEST_URI'] ?? 'æœªçŸ¥'); ?></td></tr>
                <tr><td>HTTPS çŠ¶æ€</td><td><?php echo (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'å¯ç”¨' : 'æœªå¯ç”¨'; ?></td></tr>
            </table>
        </div>
        
        <div class="php-info">
            <h3>âš™ï¸ PHP-FPM ç¯å¢ƒä¿¡æ¯</h3>
            <table>
                <tr><th>é…ç½®é¡¹</th><th>å€¼</th></tr>
                <tr><td>PHP ç‰ˆæœ¬</td><td><?php echo htmlspecialchars(PHP_VERSION); ?></td></tr>
                <tr><td>SAPI</td><td><?php echo htmlspecialchars(php_sapi_name()); ?></td></tr>
                <tr><td>å†…å­˜é™åˆ¶</td><td><?php echo htmlspecialchars(ini_get('memory_limit')); ?></td></tr>
                <tr><td>ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶</td><td><?php echo htmlspecialchars(ini_get('upload_max_filesize')); ?></td></tr>
                <tr><td>æ‰§è¡Œæ—¶é—´é™åˆ¶</td><td><?php echo htmlspecialchars(ini_get('max_execution_time')); ?>ç§’</td></tr>
                <tr><td>OpCache çŠ¶æ€</td><td><?php echo extension_loaded('Zend OPcache') ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'; ?></td></tr>
            </table>
        </div>
        
        <div class="warning">
            <strong>âš ï¸ å®‰å…¨æé†’ï¼š</strong>
            <ul>
                <li>æ­¤æµ‹è¯•é¡µé¢åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸­è¯·åŠ¡å¿…åˆ é™¤æˆ–é™åˆ¶è®¿é—®æƒé™</li>
                <li>å»ºè®®ä½¿ç”¨ IP ç™½åå•æˆ–åŸºæœ¬è®¤è¯æ¥ä¿æŠ¤æ­¤é¡µé¢</li>
                <li>å®šæœŸæ£€æŸ¥å’Œæ›´æ–°æ•°æ®åº“å¯†ç </li>
                <li>å¯ç”¨æ•°æ®åº“è¿æ¥çš„ SSL/TLS åŠ å¯†</li>
                <li>é…ç½®é€‚å½“çš„é˜²ç«å¢™è§„åˆ™é™åˆ¶æ•°æ®åº“è®¿é—®</li>
                <li>å®šæœŸå¤‡ä»½é‡è¦æ•°æ®</li>
            </ul>
        </div>
        
        <p><strong>æµ‹è¯•å®Œæˆæ—¶é—´ï¼š</strong> <?php echo date('Y-m-d H:i:s'); ?></p>
        <p><strong>LNMP æ ˆç»„ä»¶ï¼š</strong> Nginx + PHP-FPM + MySQL</p>
    </div>
</body>
</html>
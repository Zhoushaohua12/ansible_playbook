---
# ⚠️ 教学声明：本 playbook 主要用于学习 PostgreSQL 备份策略配置，请在测试环境验证后再应用于生产。
# 功能说明：自动化配置 PostgreSQL 数据库备份，包括逻辑备份（pg_dump）、物理备份（pg_basebackup）和 WAL 归档
- name: PostgreSQL 数据库备份配置
  hosts: postgresql_servers
  gather_facts: true
  become: yes
  vars_files:
    - vars/default.yml

  handlers:
    - name: 重启 PostgreSQL 服务
      ansible.builtin.service:
        name: "{{ postgresql_service_name if ansible_os_family == 'RedHat' else postgresql_service_name_debian }}"
        state: restarted
      listen: "restart postgresql"

    - name: 重新加载 PostgreSQL 配置
      ansible.builtin.service:
        name: "{{ postgresql_service_name if ansible_os_family == 'RedHat' else postgresql_service_name_debian }}"
        state: reloaded
      listen: "reload postgresql"

  tasks:
    - name: 前置检查 - 验证必需变量
      ansible.builtin.assert:
        that:
          - postgresql_backup_enabled is defined
          - postgresql_backup_enabled | bool
          - postgresql_backup_dir is defined
          - postgresql_backup_user is defined
        fail_msg: "必需的 PostgreSQL 备份配置变量未正确设置"
      tags: [postgresql, backup, validation]

    - name: 执行 PostgreSQL 备份配置
      when: postgresql_backup_enabled | bool
      tags: [postgresql, backup]
      block:
        - name: 包含 PostgreSQL 备份角色
          ansible.builtin.include_role:
            name: postgresql_backup

        - name: 创建备份目录结构
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            owner: "{{ postgresql_user }}"
            group: "{{ postgresql_group }}"
            mode: '0755'
          loop:
            - "{{ postgresql_backup_dir }}"
            - "{{ postgresql_backup_dir }}/daily"
            - "{{ postgresql_backup_dir }}/weekly"
            - "{{ postgresql_backup_dir }}/monthly"
            - "{{ postgresql_backup_dir }}/logs"
          tags: [postgresql, backup, directories]

        - name: 创建 WAL 归档目录（如果启用）
          ansible.builtin.file:
            path: "{{ postgresql_wal_archive_dir }}"
            state: directory
            owner: "{{ postgresql_user }}"
            group: "{{ postgresql_group }}"
            mode: '0700'
          when: postgresql_wal_archive_enabled | bool
          tags: [postgresql, backup, wal]

        - name: 部署 PostgreSQL 逻辑备份脚本
          ansible.builtin.template:
            src: templates/postgresql_backup.sh.j2
            dest: /usr/local/bin/postgresql_backup.sh
            owner: root
            group: root
            mode: '0755'
          tags: [postgresql, backup, scripts]

        - name: 部署 PostgreSQL 备份清理脚本
          ansible.builtin.template:
            src: templates/postgresql_backup_cleanup.sh.j2
            dest: /usr/local/bin/postgresql_backup_cleanup.sh
            owner: root
            group: root
            mode: '0755'
          tags: [postgresql, backup, scripts]

        - name: 配置 PostgreSQL 备份 cron 任务（每日备份）
          ansible.builtin.cron:
            name: "PostgreSQL 每日备份"
            minute: "{{ postgresql_backup_cron_minute }}"
            hour: "{{ postgresql_backup_cron_hour }}"
            weekday: "*"
            user: "{{ postgresql_user }}"
            job: "/usr/local/bin/postgresql_backup.sh daily >> {{ postgresql_backup_dir }}/logs/backup.log 2>&1"
            state: present
          tags: [postgresql, backup, cron]

        - name: 配置 PostgreSQL 备份清理 cron 任务
          ansible.builtin.cron:
            name: "PostgreSQL 备份清理"
            minute: "0"
            hour: "4"
            weekday: "*"
            user: "{{ postgresql_user }}"
            job: "/usr/local/bin/postgresql_backup_cleanup.sh >> {{ postgresql_backup_dir }}/logs/cleanup.log 2>&1"
            state: present
          tags: [postgresql, backup, cron]

        - name: 配置 WAL 归档（如果启用）
          ansible.builtin.lineinfile:
            path: "{{ postgresql_config_dir if ansible_os_family == 'RedHat' else postgresql_config_dir_debian }}/postgresql.conf"
            regexp: "^#?archive_mode ="
            line: "archive_mode = {{ postgresql_archive_mode }}"
            state: present
            backup: yes
          when: postgresql_wal_archive_enabled | bool
          notify: restart postgresql
          tags: [postgresql, backup, wal]

        - name: 配置 WAL 归档命令（如果启用）
          ansible.builtin.lineinfile:
            path: "{{ postgresql_config_dir if ansible_os_family == 'RedHat' else postgresql_config_dir_debian }}/postgresql.conf"
            regexp: "^#?archive_command ="
            line: "archive_command = 'test ! -f {{ postgresql_wal_archive_dir }}/%f && cp %p {{ postgresql_wal_archive_dir }}/%f'"
            state: present
            backup: yes
          when: postgresql_wal_archive_enabled | bool
          notify: restart postgresql
          tags: [postgresql, backup, wal]

        - name: 配置 .pgpass 文件（用于自动化备份）
          ansible.builtin.template:
            src: templates/pgpass.j2
            dest: "/var/lib/postgresql/.pgpass"
            owner: "{{ postgresql_user }}"
            group: "{{ postgresql_group }}"
            mode: '0600'
          tags: [postgresql, backup, config]

        - name: 验证 PostgreSQL 服务可访问性
          community.postgresql.postgresql_ping:
          become_user: "{{ postgresql_user }}"
          register: postgresql_ping_result
          environment:
            PGDATA: "{{ postgresql_data_dir if ansible_os_family == 'RedHat' else postgresql_data_dir_debian }}"
          tags: [postgresql, backup, verify]

        - name: 执行测试备份（check_mode 时跳过）
          ansible.builtin.command:
            cmd: "/usr/local/bin/postgresql_backup.sh test"
          become_user: "{{ postgresql_user }}"
          register: postgresql_backup_test
          changed_when: false
          failed_when: false
          when: not ansible_check_mode
          tags: [postgresql, backup, test]

        - name: 验证备份目录权限
          ansible.builtin.file:
            path: "{{ postgresql_backup_dir }}"
            state: directory
            owner: "{{ postgresql_user }}"
            group: "{{ postgresql_group }}"
            mode: '0755'
          check_mode: yes
          register: backup_dir_check
          tags: [postgresql, backup, verify]

        - name: 检查备份磁盘空间
          ansible.builtin.shell: |
            df -h {{ postgresql_backup_dir }} | tail -1 | awk '{print $5}' | sed 's/%//'
          register: backup_disk_usage
          changed_when: false
          tags: [postgresql, backup, verify]

        - name: 警告 - 备份磁盘空间不足
          ansible.builtin.debug:
            msg:
              - "⚠️ 警告：备份磁盘使用率较高！"
              - "当前使用率: {{ backup_disk_usage.stdout }}%"
              - "建议保持备份磁盘使用率低于 80%"
          when: backup_disk_usage.stdout | int > 80
          tags: [postgresql, backup, verify]

        - name: 输出 PostgreSQL 备份配置信息
          ansible.builtin.debug:
            msg:
              - "PostgreSQL 备份配置完成！"
              - "备份目录: {{ postgresql_backup_dir }}"
              - "备份类型: {{ postgresql_backup_type }}"
              - "备份保留天数: {{ postgresql_backup_retention_days }}"
              - "备份时间: 每天 {{ postgresql_backup_cron_hour }}:{{ postgresql_backup_cron_minute }}"
              - "压缩方式: {{ postgresql_backup_compress_method if postgresql_backup_compress else '不压缩' }}"
              - "WAL 归档: {{ '已启用' if postgresql_wal_archive_enabled | bool else '未启用' }}"
              - "备份脚本: /usr/local/bin/postgresql_backup.sh"
              - "备份日志: {{ postgresql_backup_dir }}/logs/backup.log"
              - "磁盘使用率: {{ backup_disk_usage.stdout }}%"
              - "⚠️ 请定期验证备份可恢复性"
              - "⚠️ 建议将备份异地存储以防灾难恢复"
          tags: [postgresql, backup, info]

      rescue:
        - name: 错误处理 - 记录失败信息
          ansible.builtin.debug:
            msg:
              - "PostgreSQL 备份配置失败"
              - "错误信息: {{ ansible_failed_result | default('未知错误') }}"

        - name: 错误处理 - 检查备份目录
          ansible.builtin.stat:
            path: "{{ postgresql_backup_dir }}"
          register: backup_dir_stat
          failed_when: false

        - name: 错误处理 - 显示备份目录状态
          ansible.builtin.debug:
            msg:
              - "备份目录状态："
              - "路径: {{ postgresql_backup_dir }}"
              - "存在: {{ backup_dir_stat.stat.exists | default(false) }}"
              - "可写: {{ backup_dir_stat.stat.writeable | default(false) }}"
          when: backup_dir_stat is defined

        - name: 错误处理 - 检查磁盘空间
          ansible.builtin.shell: |
            df -h {{ postgresql_backup_dir | dirname }}
          register: disk_space_info
          changed_when: false
          failed_when: false

        - name: 错误处理 - 显示磁盘空间信息
          ansible.builtin.debug:
            var: disk_space_info.stdout_lines

        - name: 错误处理 - 终止 playbook 执行
          ansible.builtin.fail:
            msg: "PostgreSQL 备份配置失败，请根据上述信息进行排查"

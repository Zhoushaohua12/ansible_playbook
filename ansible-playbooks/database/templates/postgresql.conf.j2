# PostgreSQL 配置文件
# 由 Ansible 自动生成 - 请勿手动编辑
# 生成时间: {{ ansible_date_time.iso8601 }}
# 管理主机: {{ inventory_hostname }}
# PostgreSQL 版本: {{ postgresql_version }}

# ============================================================================
# 连接和认证配置
# ============================================================================
listen_addresses = '{{ postgresql_listen_addresses }}'
port = {{ postgresql_port }}
max_connections = {{ postgresql_max_connections }}
superuser_reserved_connections = 3

# ============================================================================
# 内存配置
# ============================================================================
shared_buffers = {{ postgresql_shared_buffers }}
effective_cache_size = {{ postgresql_effective_cache_size }}
maintenance_work_mem = {{ postgresql_maintenance_work_mem }}
work_mem = {{ postgresql_work_mem }}
wal_buffers = {{ postgresql_wal_buffers }}

# ============================================================================
# 查询规划器配置
# ============================================================================
random_page_cost = {{ postgresql_random_page_cost }}
effective_io_concurrency = {{ postgresql_effective_io_concurrency }}

# ============================================================================
# WAL (预写日志) 配置
# ============================================================================
wal_level = {{ postgresql_wal_level | default('replica') }}
fsync = on
synchronous_commit = on
wal_sync_method = fsync
full_page_writes = on
wal_compression = on
wal_log_hints = on

# 检查点配置
checkpoint_timeout = 5min
checkpoint_completion_target = {{ postgresql_checkpoint_completion_target }}
max_wal_size = 1GB
min_wal_size = 80MB

{% if postgresql_replication_enabled | default(false) or postgresql_wal_archive_enabled | default(false) %}
# ============================================================================
# 复制和归档配置
# ============================================================================
max_wal_senders = {{ postgresql_max_wal_senders | default(10) }}
max_replication_slots = {{ postgresql_max_replication_slots | default(10) }}
wal_keep_size = {{ postgresql_wal_keep_size | default('1GB') }}
hot_standby = {{ postgresql_hot_standby | default('on') }}
hot_standby_feedback = {{ postgresql_hot_standby_feedback | default('on') }}

{% if postgresql_archive_mode | default('off') == 'on' %}
# WAL 归档配置
archive_mode = on
archive_command = '{{ postgresql_archive_command }}'
archive_timeout = {{ postgresql_archive_timeout | default(300) }}
{% endif %}
{% endif %}

# ============================================================================
# 并行查询配置
# ============================================================================
max_worker_processes = {{ postgresql_max_worker_processes }}
max_parallel_workers_per_gather = {{ postgresql_max_parallel_workers_per_gather }}
max_parallel_workers = {{ postgresql_max_parallel_workers }}
max_parallel_maintenance_workers = 2

# ============================================================================
# 日志配置
# ============================================================================
log_destination = '{{ postgresql_log_destination }}'
logging_collector = {{ postgresql_logging_collector }}
log_directory = '{{ postgresql_log_directory }}'
log_filename = '{{ postgresql_log_filename }}'
log_file_mode = 0600
log_truncate_on_rotation = {{ postgresql_log_truncate_on_rotation }}
log_rotation_age = {{ postgresql_log_rotation_age }}
log_rotation_size = {{ postgresql_log_rotation_size }}

# 日志内容配置
log_line_prefix = '{{ postgresql_log_line_prefix }}'
log_timezone = '{{ postgresql_log_timezone }}'
log_min_duration_statement = {{ postgresql_log_min_duration_statement }}
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_lock_waits = on
log_statement = 'none'
log_temp_files = 0

# ============================================================================
# 统计信息配置
# ============================================================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
update_process_title = on

# ============================================================================
# 自动清理（VACUUM）配置
# ============================================================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = -1

# ============================================================================
# 客户端连接默认配置
# ============================================================================
datestyle = 'iso, mdy'
timezone = '{{ postgresql_log_timezone }}'
lc_messages = '{{ postgresql_locale }}'
lc_monetary = '{{ postgresql_locale }}'
lc_numeric = '{{ postgresql_locale }}'
lc_time = '{{ postgresql_locale }}'
default_text_search_config = 'pg_catalog.english'

# ============================================================================
# 锁管理配置
# ============================================================================
deadlock_timeout = 1s
max_locks_per_transaction = 64

# ============================================================================
# SSL/TLS 配置
# ============================================================================
{% if postgresql_ssl_enabled | default(false) %}
ssl = on
ssl_cert_file = '{{ postgresql_ssl_cert_file }}'
ssl_key_file = '{{ postgresql_ssl_key_file }}'
ssl_ca_file = '{{ postgresql_ssl_ca_file }}'
ssl_prefer_server_ciphers = on
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
{% else %}
ssl = off
{% endif %}

# ============================================================================
# 其他配置
# ============================================================================
shared_preload_libraries = 'pg_stat_statements'

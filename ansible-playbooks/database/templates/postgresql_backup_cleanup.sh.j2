#!/bin/bash
# PostgreSQL 备份清理脚本
# 由 Ansible 自动生成 - 请勿手动编辑

set -euo pipefail

BACKUP_DIR="{{ postgresql_backup_dir }}"
RETENTION_DAYS="{{ postgresql_backup_retention_days }}"
LOG_FILE="${BACKUP_DIR}/logs/cleanup.log"
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

log() {
    echo "[${TIMESTAMP}] $1" | tee -a "${LOG_FILE}"
}

log "开始清理旧备份文件（保留 ${RETENTION_DAYS} 天）"

# 清理每日备份
find "${BACKUP_DIR}/daily" -type f -mtime +${RETENTION_DAYS} -delete 2>> "${LOG_FILE}" || true
# 清理每周备份
find "${BACKUP_DIR}/weekly" -type f -mtime +$((${RETENTION_DAYS} * 2)) -delete 2>> "${LOG_FILE}" || true
# 清理每月备份
find "${BACKUP_DIR}/monthly" -type f -mtime +$((${RETENTION_DAYS} * 4)) -delete 2>> "${LOG_FILE}" || true

# 清理空目录
find "${BACKUP_DIR}" -type d -empty -delete 2>> "${LOG_FILE}" || true

log "备份清理完成"

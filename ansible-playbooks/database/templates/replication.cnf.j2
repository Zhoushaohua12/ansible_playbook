# MySQL 复制配置文件
# 由 Ansible 自动生成 - 请勿手动编辑
# 生成时间: {{ ansible_date_time.iso8601 }}
# 服务器角色: {{ mysql_replication_role }}
# 服务器 ID: {{ mysql_server_id }}

[mysqld]
# 服务器标识（每台服务器必须唯一）
server-id = {{ mysql_server_id }}

# 二进制日志配置
log_bin = {{ mysql_log_bin }}
binlog_format = {{ mysql_binlog_format }}
{% if mysql_version == "8.0" %}
binlog_expire_logs_seconds = {{ mysql_expire_logs_days | default(7) * 86400 }}
{% else %}
expire_logs_days = {{ mysql_expire_logs_days | default(7) }}
{% endif %}
max_binlog_size = {{ mysql_max_binlog_size }}
sync_binlog = 1

# 二进制日志过滤（可选）
{% if mysql_binlog_do_db | default([]) | length > 0 %}
{% for db in mysql_binlog_do_db %}
binlog_do_db = {{ db }}
{% endfor %}
{% endif %}
{% if mysql_binlog_ignore_db | default([]) | length > 0 %}
{% for db in mysql_binlog_ignore_db %}
binlog_ignore_db = {{ db }}
{% endfor %}
{% endif %}

# GTID 模式配置（推荐）
{% if mysql_gtid_mode | default('OFF') == 'ON' %}
gtid_mode = ON
enforce_gtid_consistency = ON
{% endif %}

{% if mysql_replication_role == 'master' %}
# ============================================================================
# 主服务器配置
# ============================================================================

# 自动清理二进制日志
{% if mysql_version == "8.0" %}
binlog_expire_logs_seconds = {{ mysql_expire_logs_days | default(7) * 86400 }}
{% else %}
expire_logs_days = {{ mysql_expire_logs_days | default(7) }}
{% endif %}

# 半同步复制配置（可选，提高数据安全性）
# plugin-load = "rpl_semi_sync_master=semisync_master.so"
# rpl_semi_sync_master_enabled = 1
# rpl_semi_sync_master_timeout = 1000

{% elif mysql_replication_role == 'slave' %}
# ============================================================================
# 从服务器配置
# ============================================================================

# 只读模式（防止从服务器被误写）
read_only = {{ mysql_read_only | default(1) }}

# 中继日志配置
relay_log = {{ mysql_relay_log }}
relay_log_recovery = {{ mysql_relay_log_recovery }}
relay_log_purge = 1

# 并行复制配置（提高复制性能）
{% if mysql_version == "8.0" %}
replica_parallel_workers = {{ mysql_slave_parallel_workers | default(4) }}
replica_parallel_type = {{ mysql_slave_parallel_type | default('LOGICAL_CLOCK') }}
{% else %}
slave_parallel_workers = {{ mysql_slave_parallel_workers | default(4) }}
slave_parallel_type = {{ mysql_slave_parallel_type | default('LOGICAL_CLOCK') }}
{% endif %}

# 复制过滤（可选）
# replicate_do_db = dbname
# replicate_ignore_db = mysql
# replicate_ignore_db = information_schema
# replicate_ignore_db = performance_schema

# 跳过复制错误（谨慎使用）
# slave_skip_errors = 1062,1053

# 半同步复制配置（可选）
# plugin-load = "rpl_semi_sync_slave=semisync_slave.so"
# rpl_semi_sync_slave_enabled = 1

{% endif %}

# ============================================================================
# 性能优化配置
# ============================================================================

# 二进制日志缓存
binlog_cache_size = 4M
max_binlog_cache_size = 128M

# 事务提交组配置（提高复制性能）
binlog_group_commit_sync_delay = 0
binlog_group_commit_sync_no_delay_count = 0

# 行级复制配置
{% if mysql_binlog_format == 'ROW' %}
binlog_row_image = FULL  # 可选: FULL, MINIMAL, NOBLOB
{% endif %}

# ============================================================================
# 监控和诊断
# ============================================================================

# 启用复制事件校验和
binlog_checksum = CRC32
{% if mysql_version == "8.0" %}
source_verify_checksum = 1
replica_sql_verify_checksum = 1
{% else %}
master_verify_checksum = 1
slave_sql_verify_checksum = 1
{% endif %}

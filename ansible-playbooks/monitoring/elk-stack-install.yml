---
# ⚠️ 教学声明：本 playbook 主要用于学习 ELK 栈部署，请在测试环境验证后再应用于生产。
- name: ELK 栈（Elasticsearch/Logstash/Kibana）安装配置
  hosts: elk_servers
  gather_facts: true
  become: yes
  vars_files:
    - vars/default.yml

  handlers:
    - name: 重启 Elasticsearch 服务
      ansible.builtin.service:
        name: elasticsearch
        state: restarted

    - name: 重启 Logstash 服务
      ansible.builtin.service:
        name: logstash
        state: restarted

    - name: 重启 Kibana 服务
      ansible.builtin.service:
        name: kibana
        state: restarted

    - name: 重新加载 systemd 守护进程
      ansible.builtin.systemd:
        daemon_reload: yes

  tasks:
    - name: 更新 APT 包缓存
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      tags: [elk, packages]

    - name: 安装 Java 运行时环境
      ansible.builtin.package:
        name:
          - openjdk-11-jdk
          - wget
          - curl
          - gnupg
          - apt-transport-https
        state: present
      tags: [elk, packages, java]

    - name: 验证 Java 安装
      ansible.builtin.command: java -version
      register: java_version
      changed_when: false
      tags: [elk, verify]

    - name: 设置 Java 环境变量
      ansible.builtin.lineinfile:
        path: /etc/environment
        line: 'JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64'
        create: yes
      tags: [elk, java]

    - name: 添加 Elasticsearch GPG 密钥
      ansible.builtin.apt_key:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present
      tags: [elk, elasticsearch, packages]

    - name: 添加 Elasticsearch APT 仓库
      ansible.builtin.apt_repository:
        repo: "deb https://artifacts.elastic.co/packages/8.x/apt stable main"
        state: present
        update_cache: yes
      tags: [elk, elasticsearch, packages]

    - name: 安装 Elasticsearch
      ansible.builtin.package:
        name: "elasticsearch={{ elasticsearch_version }}"
        state: present
        allow_unauthenticated: yes
      when: elasticsearch_enabled
      tags: [elk, elasticsearch, install]

    - name: 创建 Elasticsearch 数据目录
      ansible.builtin.file:
        path: "{{ elasticsearch_data_dir }}"
        state: directory
        owner: "{{ elasticsearch_user }}"
        group: "{{ elasticsearch_group }}"
        mode: '0755'
      when: elasticsearch_enabled
      tags: [elk, elasticsearch, directories]

    - name: 配置 Elasticsearch
      ansible.builtin.template:
        src: templates/elasticsearch.yml.j2
        dest: "{{ elasticsearch_config_dir }}/elasticsearch.yml"
        owner: root
        group: "{{ elasticsearch_group }}"
        mode: '0660'
        backup: yes
      notify: 重启 Elasticsearch 服务
      when: elasticsearch_enabled
      tags: [elk, elasticsearch, config]

    - name: 配置 JVM 选项
      ansible.builtin.template:
        src: templates/jvm.options.j2
        dest: "{{ elasticsearch_config_dir }}/jvm.options.d/custom.options"
        owner: root
        group: "{{ elasticsearch_group }}"
        mode: '0660'
      notify: 重启 Elasticsearch 服务
      when: elasticsearch_enabled
      tags: [elk, elasticsearch, config]

    - name: 启动并启用 Elasticsearch 服务
      ansible.builtin.service:
        name: elasticsearch
        state: started
        enabled: yes
      when: elasticsearch_enabled
      tags: [elk, elasticsearch, service]

    - name: 等待 Elasticsearch 服务就绪
      ansible.builtin.wait_for:
        port: "{{ elasticsearch_http_port }}"
        delay: 10
        timeout: 120
        state: started
      when: elasticsearch_enabled
      tags: [elk, elasticsearch, verify]

    - name: 验证 Elasticsearch 集群健康状态
      ansible.builtin.uri:
        url: "http://localhost:{{ elasticsearch_http_port }}/_cluster/health"
        method: GET
        status_code: 200
        return_content: yes
      register: es_health
      retries: 10
      delay: 10
      when: elasticsearch_enabled
      tags: [elk, elasticsearch, verify]

    - name: 安装 Logstash
      ansible.builtin.package:
        name: "logstash={{ logstash_version }}"
        state: present
        allow_unauthenticated: yes
      when: logstash_enabled
      tags: [elk, logstash, install]

    - name: 创建 Logstash 配置目录
      ansible.builtin.file:
        path: "{{ logstash_config_dir }}/conf.d"
        state: directory
        owner: "{{ logstash_user }}"
        group: "{{ logstash_group }}"
        mode: '0755'
      when: logstash_enabled
      tags: [elk, logstash, directories]

    - name: 配置 Logstash 主配置文件
      ansible.builtin.template:
        src: templates/logstash.yml.j2
        dest: "{{ logstash_config_dir }}/logstash.yml"
        owner: root
        group: "{{ logstash_group }}"
        mode: '0660'
        backup: yes
      notify: 重启 Logstash 服务
      when: logstash_enabled
      tags: [elk, logstash, config]

    - name: 配置 Logstash 管道
      ansible.builtin.template:
        src: templates/logstash.conf.j2
        dest: "{{ logstash_config_dir }}/conf.d/main.conf"
        owner: "{{ logstash_user }}"
        group: "{{ logstash_group }}"
        mode: '0644'
        backup: yes
      notify: 重启 Logstash 服务
      when: logstash_enabled
      tags: [elk, logstash, config]

    - name: 启动并启用 Logstash 服务
      ansible.builtin.service:
        name: logstash
        state: started
        enabled: yes
      when: logstash_enabled
      tags: [elk, logstash, service]

    - name: 等待 Logstash 服务就绪
      ansible.builtin.wait_for:
        port: "{{ logstash_port }}"
        delay: 10
        timeout: 60
        state: started
      when: logstash_enabled
      tags: [elk, logstash, verify]

    - name: 安装 Kibana
      ansible.builtin.package:
        name: "kibana={{ kibana_version }}"
        state: present
        allow_unauthenticated: yes
      when: kibana_enabled
      tags: [elk, kibana, install]

    - name: 配置 Kibana
      ansible.builtin.template:
        src: templates/kibana.yml.j2
        dest: "{{ kibana_config_dir }}/kibana.yml"
        owner: root
        group: "{{ kibana_group }}"
        mode: '0660'
        backup: yes
      notify: 重启 Kibana 服务
      when: kibana_enabled
      tags: [elk, kibana, config]

    - name: 启动并启用 Kibana 服务
      ansible.builtin.service:
        name: kibana
        state: started
        enabled: yes
      when: kibana_enabled
      tags: [elk, kibana, service]

    - name: 等待 Kibana 服务就绪
      ansible.builtin.wait_for:
        port: "{{ kibana_port }}"
        delay: 10
        timeout: 120
        state: started
      when: kibana_enabled
      tags: [elk, kibana, verify]

    - name: 验证 Kibana 健康状态
      ansible.builtin.uri:
        url: "http://localhost:{{ kibana_port }}/api/status"
        method: GET
        status_code: 200
        return_content: yes
      register: kibana_health
      retries: 10
      delay: 10
      when: kibana_enabled
      tags: [elk, kibana, verify]

    - name: 安装 Filebeat
      ansible.builtin.package:
        name: "filebeat={{ filebeat_version }}"
        state: present
        allow_unauthenticated: yes
      when: filebeat_enabled
      tags: [elk, filebeat, install]

    - name: 配置 Filebeat
      ansible.builtin.template:
        src: templates/filebeat.yml.j2
        dest: "{{ filebeat_config_dir }}/filebeat.yml"
        owner: root
        group: root
        mode: '0600'
        backup: yes
      when: filebeat_enabled
      tags: [elk, filebeat, config]

    - name: 启用 Filebeat 系统模块
      ansible.builtin.command: "filebeat modules enable system"
      when: filebeat_enabled
      tags: [elk, filebeat, modules]

    - name: 启动并启用 Filebeat 服务
      ansible.builtin.service:
        name: filebeat
        state: started
        enabled: yes
      when: filebeat_enabled
      tags: [elk, filebeat, service]

    - name: 配置系统虚拟内存参数
      ansible.builtin.sysctl:
        name: vm.max_map_count
        value: "{{ monitoring_max_map_count }}"
        state: present
        sysctl_set: yes
        reload: yes
      tags: [elk, system]

    - name: 配置防火墙规则（开放 ELK 端口）
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "{{ elasticsearch_http_port }}"
        - "{{ kibana_port }}"
        - "{{ logstash_port }}"
      when: monitoring_firewall_enabled and ansible_os_family == "Debian"
      tags: [elk, firewall]

    - name: 输出 ELK 栈安装信息
      ansible.builtin.debug:
        msg:
          - "ELK 栈安装配置完成！"
          - "Elasticsearch: http://localhost:{{ elasticsearch_http_port }}"
          - "Kibana: http://localhost:{{ kibana_port }}"
          - "Logstash: http://localhost:{{ logstash_port }}"
          - "Elasticsearch 版本: {{ elasticsearch_version }}"
          - "Logstash 版本: {{ logstash_version }}"
          - "Kibana 版本: {{ kibana_version }}"
          - "Filebeat 版本: {{ filebeat_version }}"
          - "集群名称: {{ elasticsearch_cluster_name }}"
          - "节点名称: {{ elasticsearch_node_name }}"
      tags: [elk, info]
---
# ⚠️ 教学声明：本 playbook 主要用于学习系统安全加固，请在测试环境验证后再应用于生产。
- name: 通用系统安全加固配置
  hosts: all
  gather_facts: true
  become: yes
  vars_files:
    - vars/default.yml

  handlers:
    - import_tasks: handlers/main.yml

  tasks:
    - name: 显示安全加固信息
      ansible.builtin.debug:
        msg:
          - "开始通用系统安全加固"
          - "目标主机: {{ inventory_hostname }}"
          - "操作系统: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "加固级别: {{ security_hardening_level | default('standard') }}"
      tags: [security, info]

    - name: 应用安全基线角色
      ansible.builtin.include_role:
        name: security_baseline
      tags: [security, baseline]

    - name: 应用用户加固角色
      ansible.builtin.include_role:
        name: users_hardening
      tags: [security, users]

    - name: 应用防火墙角色
      ansible.builtin.include_role:
        name: firewall
      tags: [security, firewall]

    - name: 内核参数安全加固
      block:
        - name: 配置内核安全参数
          ansible.builtin.sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            state: present
            sysctl_file: /etc/sysctl.d/99-security.conf
            reload: yes
          loop: "{{ kernel_security_params }}"
          when: kernel_hardening_enabled and not ansible_check_mode
      rescue:
        - name: 内核参数配置失败处理
          ansible.builtin.debug:
            msg: "内核参数配置失败，请检查参数名称和值"
      tags: [security, kernel]

    - name: 文件系统安全加固
      block:
        - name: 设置关键文件权限
          ansible.builtin.file:
            path: "{{ item.path }}"
            mode: "{{ item.mode }}"
            owner: "{{ item.owner | default('root') }}"
            group: "{{ item.group | default('root') }}"
          loop: "{{ critical_file_permissions }}"
          when: not ansible_check_mode

        - name: 创建安全目录
          ansible.builtin.file:
            path: "{{ item.path }}"
            state: directory
            mode: "{{ item.mode }}"
            owner: "{{ item.owner | default('root') }}"
            group: "{{ item.group | default('root') }}"
          loop: "{{ secure_directories }}"
          when: not ansible_check_mode
      rescue:
        - name: 文件系统加固失败处理
          ansible.builtin.debug:
            msg: "文件系统安全加固失败，请检查文件路径和权限设置"
      tags: [security, filesystem]

    - name: 日志和监控加固
      block:
        - name: 配置日志轮转
          ansible.builtin.template:
            src: templates/logrotate-security.j2
            dest: /etc/logrotate.d/security
            owner: root
            group: root
            mode: '0644'
          when: log_rotation_enabled and not ansible_check_mode

        - name: 配置系统日志
          ansible.builtin.lineinfile:
            path: /etc/rsyslog.d/security.conf
            line: "{{ item }}"
            create: yes
          loop: "{{ security_log_rules }}"
          when: logging_enabled and not ansible_check_mode
          notify: 重启 rsyslog 服务
      rescue:
        - name: 日志配置失败处理
          ansible.builtin.debug:
            msg: "日志配置失败，请检查日志规则语法"
      tags: [security, logging]

    - name: 服务安全加固
      block:
        - name: 禁用不必要的服务
          ansible.builtin.service:
            name: "{{ item }}"
            state: stopped
            enabled: no
          loop: "{{ disabled_services }}"
          when: service_hardening_enabled and not ansible_check_mode
          ignore_errors: yes

        - name: 启用必要的安全服务
          ansible.builtin.service:
            name: "{{ item }}"
            state: started
            enabled: yes
          loop: "{{ enabled_security_services }}"
          when: service_hardening_enabled and not ansible_check_mode
      rescue:
        - name: 服务加固失败处理
          ansible.builtin.debug:
            msg: "服务加固失败，请检查服务名称和状态"
      tags: [security, services]

    - name: 定时任务安全加固
      block:
        - name: 配置安全定时任务
          ansible.builtin.cron:
            name: "{{ item.name }}"
            job: "{{ item.job }}"
            minute: "{{ item.minute | default('0') }}"
            hour: "{{ item.hour | default('2') }}"
            day: "{{ item.day | default('*') }}"
            month: "{{ item.month | default('*') }}"
            weekday: "{{ item.weekday | default('*') }}"
            user: "{{ item.user | default('root') }}"
            cron_file: security
          loop: "{{ security_cron_jobs }}"
          when: security_cron_enabled and not ansible_check_mode
      rescue:
        - name: 定时任务配置失败处理
          ansible.builtin.debug:
            msg: "定时任务配置失败，请检查任务配置参数"
      tags: [security, cron]

    - name: 网络安全加固
      block:
        - name: 配置网络参数安全
          ansible.builtin.sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            state: present
            sysctl_file: /etc/sysctl.d/99-network-security.conf
            reload: yes
          loop: "{{ network_security_params }}"
          when: network_hardening_enabled and not ansible_check_mode

        - name: 配置 hosts 文件
          ansible.builtin.lineinfile:
            path: /etc/hosts
            line: "{{ item }}"
          loop: "{{ hosts_entries }}"
          when: hosts_file_hardening and not ansible_check_mode
      rescue:
        - name: 网络安全加固失败处理
          ansible.builtin.debug:
            msg: "网络安全加固失败，请检查网络参数配置"
      tags: [security, network]

    - name: 应用程序安全加固
      block:
        - name: 配置应用安全配置文件
          ansible.builtin.template:
            src: "templates/{{ item.template }}"
            dest: "{{ item.dest }}"
            owner: "{{ item.owner | default('root') }}"
            group: "{{ item.group | default('root') }}"
            mode: "{{ item.mode | default('0644') }}"
            backup: yes
          loop: "{{ application_security_configs }}"
          when: application_hardening_enabled and not ansible_check_mode
      rescue:
        - name: 应用程序加固失败处理
          ansible.builtin.debug:
            msg: "应用程序安全加固失败，请检查配置模板"
      tags: [security, applications]

    - name: 安全加固完成信息
      ansible.builtin.debug:
        msg:
          - "通用系统安全加固完成！"
          - "加固级别: {{ security_hardening_level | default('standard') }}"
          - "内核加固: {{ '已启用' if kernel_hardening_enabled else '已禁用' }}"
          - "文件系统加固: {{ '已启用' if filesystem_hardening_enabled else '已禁用' }}"
          - "服务加固: {{ '已启用' if service_hardening_enabled else '已禁用' }}"
          - "网络加固: {{ '已启用' if network_hardening_enabled else '已禁用' }}"
          - "日志监控: {{ '已启用' if logging_enabled else '已禁用' }}"
      tags: [security, info]
---
# 用户安全加固角色任务
# 负责创建用户、配置权限和实施用户安全策略

- name: 显示用户加固信息
  ansible.builtin.debug:
    msg:
      - "开始用户安全加固"
      - "目标系统: {{ ansible_distribution }}"
      - "加固模式: {{ '检查模式' if ansible_check_mode else '实际加固' }}"
  tags: [users, info]

- name: 创建基础系统用户
  block:
    - name: 创建用户账户
      ansible.builtin.user:
        name: "{{ item.name }}"
        comment: "{{ item.comment | default('') }}"
        shell: "{{ item.shell | default('/bin/bash') }}"
        groups: "{{ item.groups | default([]) }}"
        append: yes
        state: present
        create_home: yes
      loop: "{{ baseline_users }}"
      when: not ansible_check_mode
      register: user_creation_result

    - name: 显示用户创建结果
      ansible.builtin.debug:
        msg:
          - "用户 {{ item.item.name }} 创建状态: {{ '成功' if item.changed else '已存在' }}"
      loop: "{{ user_creation_result.results }}"
      when: user_creation_result is defined
  rescue:
    - name: 用户创建失败处理
      ansible.builtin.debug:
        msg: "用户创建失败，请检查用户名和权限设置"
  tags: [users, create]

- name: 配置用户 SSH 公钥
  block:
    - name: 为用户部署 SSH 公钥
      ansible.builtin.authorized_key:
        user: "{{ item.name }}"
        state: present
        key: "{{ item.vault_ssh_public_key }}"
        manage_dir: yes
      loop: "{{ baseline_users }}"
      when: 
        - item.vault_ssh_public_key is defined
        - item.vault_ssh_public_key != ""
        - not ansible_check_mode
  rescue:
    - name: SSH 公钥配置失败处理
      ansible.builtin.debug:
        msg: "SSH 公钥配置失败，请检查公钥格式和权限"
  tags: [users, ssh]

- name: 配置用户 sudo 权限
  block:
    - name: 为用户配置 sudo 权限
      ansible.builtin.lineinfile:
        path: "/etc/sudoers.d/{{ item.name }}"
        line: "{{ item.name }} ALL=(ALL) {{ 'NOPASSWD:' if item.nopasswd | default(false) else '' }}ALL"
        create: yes
        mode: '0440'
        validate: /usr/sbin/visudo -cf %s
      loop: "{{ baseline_users }}"
      when: 
        - item.sudo_access | default(false)
        - not ansible_check_mode

    - name: 验证 sudo 配置语法
      ansible.builtin.command: /usr/sbin/visudo -c
      register: sudo_validation
      failed_when: sudo_validation.rc != 0
      changed_when: false
  rescue:
    - name: sudo 权限配置失败处理
      ansible.builtin.debug:
        msg: "sudo 权限配置失败，请检查配置语法"
  tags: [users, sudo]

- name: 禁用不必要的系统账户
  block:
    - name: 锁定不必要系统账户
      ansible.builtin.user:
        name: "{{ item }}"
        shell: /usr/sbin/nologin
        state: present
      loop: "{{ disabled_system_accounts }}"
      when: not ansible_check_mode

    - name: 禁用系统账户密码
      ansible.builtin.command: passwd -l {{ item }}
      loop: "{{ disabled_system_accounts }}"
      when: not ansible_check_mode
      register: account_lock_result
      failed_when: false
      changed_when: account_lock_result.rc == 0
  rescue:
    - name: 系统账户禁用失败处理
      ansible.builtin.debug:
        msg: "系统账户禁用失败，请检查账户名称和权限"
  tags: [users, disable]

- name: 配置用户密码策略
  block:
    - name: 配置密码复杂度策略 (PAM)
      ansible.builtin.lineinfile:
        path: "{{ item.path }}"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop: "{{ password_policies }}"
      when: not ansible_check_mode

    - name: 设置密码过期策略
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop: "{{ password_expiry_policies }}"
      when: not ansible_check_mode
  rescue:
    - name: 密码策略配置失败处理
      ansible.builtin.debug:
        msg: "密码策略配置失败，请检查策略参数"
  tags: [users, password]

- name: 配置用户会话限制
  block:
    - name: 配置用户会话超时
      ansible.builtin.lineinfile:
        path: /etc/profile.d/session-timeout.sh
        line: "{{ item }}"
        create: yes
        mode: '0644'
      loop: "{{ session_timeout_config }}"
      when: not ansible_check_mode

    - name: 配置用户进程限制
      ansible.builtin.template:
        src: limits.conf.j2
        dest: /etc/security/limits.d/user-limits.conf
        owner: root
        group: root
        mode: '0644'
        backup: yes
      when: not ansible_check_mode
  rescue:
    - name: 会话限制配置失败处理
      ansible.builtin.debug:
        msg: "用户会话限制配置失败，请检查限制参数"
  tags: [users, session]

- name: 创建用户组
  block:
    - name: 创建自定义用户组
      ansible.builtin.group:
        name: "{{ item.name }}"
        state: present
        system: "{{ item.system | default(false) }}"
      loop: "{{ custom_groups }}"
      when: not ansible_check_mode

    - name: 将用户添加到自定义组
      ansible.builtin.user:
        name: "{{ item.user }}"
        groups: "{{ item.group }}"
        append: yes
      loop: "{{ user_group_assignments }}"
      when: not ansible_check_mode
  rescue:
    - name: 用户组配置失败处理
      ansible.builtin.debug:
        msg: "用户组配置失败，请检查组名和用户分配"
  tags: [users, groups]

- name: 配置用户登录横幅
  block:
    - name: 设置登录前横幅
      ansible.builtin.copy:
        content: "{{ login_banner_pre }}"
        dest: /etc/issue.net
        owner: root
        group: root
        mode: '0644'
        backup: yes
      when: not ansible_check_mode

    - name: 设置登录后横幅
      ansible.builtin.template:
        src: motd.j2
        dest: /etc/motd
        owner: root
        group: root
        mode: '0644'
        backup: yes
      when: not ansible_check_mode
  rescue:
    - name: 登录横幅配置失败处理
      ansible.builtin.debug:
        msg: "登录横幅配置失败，请检查横幅内容"
  tags: [users, banner]

- name: 用户加固完成验证
  block:
    - name: 验证用户账户状态
      ansible.builtin.command: id {{ item.name }}
      loop: "{{ baseline_users }}"
      register: user_verification
      failed_when: false
      changed_when: false

    - name: 验证 sudo 配置
      ansible.builtin.command: sudo -n -U {{ item.name }} -l
      loop: "{{ baseline_users }}"
      when: item.sudo_access | default(false)
      register: sudo_verification
      failed_when: false
      changed_when: false

    - name: 显示验证结果
      ansible.builtin.debug:
        msg:
          - "用户加固验证结果:"
          - "用户账户: {{ '正常' if user_verification.results | selectattr('rc', 'equalto', 0) | list | length == baseline_users | length else '异常' }}"
          - "sudo 权限: {{ '正常' if sudo_verification.results | selectattr('rc', 'equalto', 0) | list | length > 0 else '需检查' }}"
  tags: [users, verify]

- name: 用户安全加固完成信息
  ansible.builtin.debug:
    msg:
      - "用户安全加固完成！"
      - "创建用户数: {{ baseline_users | length }}"
      - "sudo 用户数: {{ baseline_users | selectattr('sudo_access', 'equalto', true) | list | length }}"
      - "禁用账户数: {{ disabled_system_accounts | length }}"
      - "密码策略: {{ '已配置' if password_policies | length > 0 else '未配置' }}"
  tags: [users, info]
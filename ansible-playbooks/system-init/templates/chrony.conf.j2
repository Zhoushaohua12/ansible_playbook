# Chrony 时间同步服务配置文件
# 此文件由 Ansible 自动生成，请勿手动修改
# 配置时间: {{ ansible_date_time.iso8601 }}

# ============================================================================
# 服务器配置
# ============================================================================

# 公共 NTP 服务器
# 中国地区 NTP 服务器池
server 0.cn.pool.ntp.org iburst
server 1.cn.pool.ntp.org iburst
server 2.cn.pool.ntp.org iburst
server 3.cn.pool.ntp.org iburst

# 备用国际 NTP 服务器
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst
server 3.pool.ntp.org iburst

# 本地时钟作为备用服务器
server 127.127.1.0
fudge  127.127.1.0 stratum 10

# ============================================================================
# 客户端配置
# ============================================================================

# 允许来自指定网络的客户端访问
# 仅允许本地网络访问时间同步服务
allow 127.0.0.0/8
allow ::1/128

# 如果配置了本地网络，允许局域网访问
{% for interface in network_interfaces %}
{% if interface.method == 'static' and interface.address is defined %}
{% set network = interface.address.split('.') %}
allow {{ network[0] }}.{{ network[1] }}.{{ network[2] }}.0/24
{% endif %}
{% endfor %}

# ============================================================================
# 日志配置
# ============================================================================

# 日志目录
logdir /var/log/chrony

# 记录测量统计信息
log measurements statistics tracking

# 记录时钟漂移率变化
log rawmeasurements

# 记录参考时钟状态变化
log refclocks

# ============================================================================
# 安全配置
# ============================================================================

# 启用 NTP 认证
# 注意：需要配置密钥文件
# keyfile /etc/chrony.keys
# generatecommandkey yes

# 限制访问控制
# 限制命令访问权限
cmdallow 127.0.0.0/8
cmddeny all

# ============================================================================
# 性能配置
# ============================================================================

# 初始同步步进阈值
makestep 1.0 3

# 最大时钟偏移
maxdistance 16.0

# 最小轮询间隔
minsources 2

# 最大轮询间隔
maxpoll 10

# 最小轮询间隔
minpoll 6

# ============================================================================
# 硬件时钟配置
# ============================================================================

# 同步硬件时钟
rtcsync

# 硬件时钟设备
rtcdevice /dev/rtc0

# 硬件时钟同步频率
rtcfile /var/lib/chrony/rtc

# ============================================================================
# 本地时钟配置
# ============================================================================

# 本地时钟层数
local stratum 10

# 孤立模式
orphan 10

# ============================================================================
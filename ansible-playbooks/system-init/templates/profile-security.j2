# 系统安全环境配置
# 此文件由 Ansible 自动生成，请勿手动修改
# 配置时间: {{ ansible_date_time.iso8601 }}

# ============================================================================
# 会话安全配置
# ============================================================================

# 会话超时设置 (10分钟)
export TMOUT=600
readonly TMOUT

# 自动登出设置
export TIMEOUT=300

# ============================================================================
# 历史记录安全配置
# ============================================================================

# 历史记录时间戳
export HISTTIMEFORMAT="%F %T "

# 历史记录大小
export HISTSIZE=10000
export HISTFILESIZE=20000

# 忽略重复命令
export HISTCONTROL=ignoredups:erasedups

# 历史记录文件
export HISTFILE=~/.bash_history_secure

# 实时写入历史记录
shopt -s histappend
export PROMPT_COMMAND="history -a; $PROMPT_COMMAND"

# ============================================================================
# 终端安全配置
# ============================================================================

# 禁用 Ctrl+D 快捷键
set -o ignoreeof

# 启用安全模式
set -o noclobber

# 键盘中断处理
stty -ctlecho

# ============================================================================
# 路径安全配置
# ============================================================================

# 安全的 PATH 设置
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# 删除当前目录从 PATH
export PATH=$(echo $PATH | tr ':' '\n' | grep -v '^\.$' | tr '\n' ':')

# ============================================================================
# 文件权限配置
# ============================================================================

# 默认文件权限
umask 027

# 临时目录权限
export TMPDIR=/tmp
export TMP=/tmp
export TEMP=/tmp

# ============================================================================
# 网络安全配置
# ============================================================================

# 代理设置 (如需要)
# export http_proxy="http://proxy.company.com:8080"
# export https_proxy="http://proxy.company.com:8080"

# ============================================================================
# 应用程序安全配置
# ============================================================================

# 编辑器安全设置
export EDITOR=vim
export VISUAL=vim

# 分页器设置
export PAGER=less
export LESS="-R -M --shift 5"

# 颜色支持
export CLICOLOR=1
export LSCOLORS=ExFxCxDxBxegedabagacad

# ============================================================================
# 安全提示配置
# ============================================================================

# 登录提示
echo "安全提醒："
echo "- 所有操作都会被记录和审计"
echo "- 请勿泄露系统认证信息"
echo "- 发现异常请立即联系管理员"
echo ""

# 检查上次登录时间
last -n 1 $USER 2>/dev/null | head -1

# ============================================================================
# 函数定义
# ============================================================================

# 安全删除函数
srm() {
    if [ $# -eq 0 ]; then
        echo "用法: srm <文件或目录>"
        return 1
    fi
    
    for file in "$@"; do
        if [ -e "$file" ]; then
            echo "安全删除: $file"
            shred -vfz -n 3 "$file" 2>/dev/null || rm -rf "$file"
        else
            echo "文件不存在: $file"
        fi
    done
}

# 安全复制函数
scopy() {
    if [ $# -lt 2 ]; then
        echo "用法: scopy <源文件> <目标文件>"
        return 1
    fi
    
    cp -p "$1" "$2"
    chmod 600 "$2"
    echo "安全复制完成: $1 -> $2"
}

# 会话锁定函数
lock_session() {
    if command -v vlock >/dev/null 2>&1; then
        vlock -a
    elif command -v gnome-screensaver-command >/dev/null 2>&1; then
        gnome-screensaver-command -l
    else
        echo "未找到可用的会话锁定工具"
    fi
}

# 安全检查函数
security_check() {
    echo "=== 系统安全检查 ==="
    echo "当前用户: $(whoami)"
    echo "登录时间: $(date)"
    echo "系统负载: $(uptime)"
    echo "磁盘使用: $(df -h / | tail -1)"
    echo "内存使用: $(free -h | grep Mem)"
    echo "网络连接: $(netstat -an 2>/dev/null | grep ESTABLISHED | wc -l) 个活跃连接"
    echo "运行进程: $(ps aux | wc -l) 个进程"
    echo "=================="
}

# ============================================================================
# 别名定义
# ============================================================================

# 安全命令别名
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'
alias ln='ln -i'

# 网络安全别名
alias netstat='netstat -an'
alias ss='ss -tuln'
alias lsof='lsof -i'

# 系统监控别名
alias psa='ps aux'
alias psm='ps aux | less'
alias topa='top -a'

# 日志查看别名
alias authlog='tail -f /var/log/auth.log'
alias seclog='tail -f /var/log/secure'
alias auditlog='tail -f /var/log/audit/audit.log'

# 快捷命令别名
alias ll='ls -alh'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# ============================================================================
# 自定义提示符
# ============================================================================

if [ "$UID" -eq 0 ]; then
    # root 用户提示符 (红色)
    export PS1='\[\033[01;31m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
else
    # 普通用户提示符 (绿色)
    export PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
fi

# ============================================================================
# 清理函数
# ============================================================================

# 会话结束时清理
cleanup_session() {
    echo "会话结束时间: $(date)"
    # 清理临时文件
    rm -f /tmp/$USER.* 2>/dev/null
    # 清理历史记录敏感信息
    sed -i '/password/d' ~/.bash_history 2>/dev/null
}

# 注册清理函数
trap cleanup_session EXIT

# ============================================================================
# 配置完成提示
# ============================================================================

echo "系统安全环境配置已加载"
echo "输入 'security_check' 进行安全检查"
echo "输入 'lock_session' 锁定会话"
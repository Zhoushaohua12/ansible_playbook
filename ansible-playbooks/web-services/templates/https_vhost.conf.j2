# HTTPS 虚拟主机配置：{{ item.server_name }}
# 中文注释：演示 HSTS、安全头部、自签名证书

server {
    listen {{ item.listen_port | default(443) }} ssl http2;
    {% if item.listen_ipv6 | default(true) %}listen [::]:{{ item.listen_port | default(443) }} ssl http2;{% endif %}
    server_name {{ item.server_name }};

    root {{ item.root }};
    index {{ item.index | default('index.html index.htm') }};

    ssl_certificate {{ item.ssl_certificate | default(nginx_ssl_certificate_dir ~ '/' ~ item.name ~ '.crt') }};
    ssl_certificate_key {{ item.ssl_certificate_key | default(nginx_ssl_certificate_dir ~ '/' ~ item.name ~ '.key') }};
    include {{ nginx_conf_d_dir }}/ssl-params.conf;

    access_log {{ item.access_log | default(nginx_log_dir ~ '/' ~ item.name ~ '_access.log') }};
    error_log {{ item.error_log | default(nginx_log_dir ~ '/' ~ item.name ~ '_error.log') }};

    {% if item.hsts_enabled | default(true) %}
    add_header Strict-Transport-Security "max-age={{ item.hsts_max_age | default(31536000) }}{% if item.hsts_include_subdomains | default(false) %}; includeSubDomains{% endif %}{% if item.hsts_preload | default(false) %}; preload{% endif %}" always;
    {% endif %}

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "{{ item.security_headers['Referrer-Policy'] if item.security_headers is defined and 'Referrer-Policy' in item.security_headers else 'no-referrer-when-downgrade' }}" always;

    {% if nginx_rate_limit_enabled %}
    limit_req zone={{ nginx_rate_limit_zone_name }} burst={{ nginx_rate_limit_burst }} {% if nginx_rate_limit_nodelay %}nodelay{% endif %};
    {% endif %}

    {% if nginx_conn_limit_enabled %}
    limit_conn {{ nginx_conn_limit_zone_name }} {{ nginx_conn_limit_number }};
    {% endif %}

    location / {
        try_files $uri $uri/ =404;
    }

    {% if nginx_cache_enabled %}
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }
    {% endif %}
}

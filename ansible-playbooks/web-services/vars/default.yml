---
# Web 服务操作包变量配置
# ⚠️ 重要提示：这些变量为示例配置，请在生产环境使用前根据实际情况调整
# 教学说明：本配置涵盖 Nginx 的安装、虚拟主机、HTTPS、负载均衡、反向代理和性能调优参数

# ============================================================================
# Nginx 通用配置
# ============================================================================
nginx_enabled: true
nginx_version: "1.24.0"  # 可选: "1.22.1", "1.24.0", "mainline"

# Nginx 安装方式
nginx_install_method: "package"  # 可选: "package" (包管理器), "source" (源码编译)

# Nginx 包名（根据发行版自动选择）
nginx_packages_redhat:
  - nginx
  - nginx-all-modules
nginx_packages_debian:
  - nginx
  - nginx-common
  - nginx-full

# Nginx 源码编译配置
nginx_source_url: "https://nginx.org/download/nginx-{{ nginx_version }}.tar.gz"
nginx_source_configure_options:
  - "--prefix=/usr/local/nginx"
  - "--conf-path=/etc/nginx/nginx.conf"
  - "--error-log-path=/var/log/nginx/error.log"
  - "--http-log-path=/var/log/nginx/access.log"
  - "--pid-path=/var/run/nginx.pid"
  - "--lock-path=/var/run/nginx.lock"
  - "--with-http_ssl_module"
  - "--with-http_v2_module"
  - "--with-http_realip_module"
  - "--with-http_addition_module"
  - "--with-http_sub_module"
  - "--with-http_dav_module"
  - "--with-http_flv_module"
  - "--with-http_mp4_module"
  - "--with-http_gunzip_module"
  - "--with-http_gzip_static_module"
  - "--with-http_random_index_module"
  - "--with-http_secure_link_module"
  - "--with-http_stub_status_module"
  - "--with-http_auth_request_module"
  - "--with-threads"
  - "--with-stream"
  - "--with-stream_ssl_module"

nginx_source_dependencies_redhat:
  - gcc
  - make
  - pcre-devel
  - zlib-devel
  - openssl-devel
  - perl
nginx_source_dependencies_debian:
  - build-essential
  - libpcre3-dev
  - zlib1g-dev
  - libssl-dev
  - perl

# Nginx 服务配置
nginx_service_name: "nginx"
nginx_user: "nginx"
nginx_group: "nginx"
nginx_user_debian: "www-data"
nginx_group_debian: "www-data"

# Nginx 路径配置
nginx_conf_dir: "/etc/nginx"
nginx_conf_file: "/etc/nginx/nginx.conf"
nginx_vhost_dir: "/etc/nginx/sites-available"
nginx_vhost_enabled_dir: "/etc/nginx/sites-enabled"
nginx_conf_d_dir: "/etc/nginx/conf.d"
nginx_log_dir: "/var/log/nginx"
nginx_cache_dir: "/var/cache/nginx"
nginx_pid_file: "/var/run/nginx.pid"

# ============================================================================
# Nginx 性能调优参数
# ============================================================================
nginx_worker_processes: "auto"  # 可选: "auto", 数字（如 4）
nginx_worker_connections: 1024
nginx_worker_rlimit_nofile: 65535
nginx_multi_accept: "on"
nginx_use_epoll: true

# 客户端请求配置
nginx_client_max_body_size: "100M"
nginx_client_body_buffer_size: "128k"
nginx_client_header_buffer_size: "1k"
nginx_large_client_header_buffers: "4 8k"
nginx_client_body_timeout: 60
nginx_client_header_timeout: 60
nginx_send_timeout: 60
nginx_keepalive_timeout: 65
nginx_keepalive_requests: 100

# Gzip 压缩配置
nginx_gzip_enabled: true
nginx_gzip_comp_level: 5
nginx_gzip_min_length: 256
nginx_gzip_proxied: "any"
nginx_gzip_vary: "on"
nginx_gzip_types:
  - text/plain
  - text/css
  - text/xml
  - text/javascript
  - application/json
  - application/javascript
  - application/xml+rss
  - application/rss+xml
  - font/truetype
  - font/opentype
  - application/vnd.ms-fontobject
  - image/svg+xml

# 缓冲区配置
nginx_proxy_buffer_size: "4k"
nginx_proxy_buffers: "4 32k"
nginx_proxy_busy_buffers_size: "64k"
nginx_proxy_temp_file_write_size: "64k"

# FastCGI 配置
nginx_fastcgi_buffer_size: "16k"
nginx_fastcgi_buffers: "4 16k"
nginx_fastcgi_busy_buffers_size: "32k"

# ============================================================================
# SSL/TLS 配置
# ============================================================================
nginx_ssl_enabled: true
nginx_ssl_protocols: "TLSv1.2 TLSv1.3"
nginx_ssl_ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
nginx_ssl_prefer_server_ciphers: "off"
nginx_ssl_session_cache: "shared:SSL:10m"
nginx_ssl_session_timeout: "10m"
nginx_ssl_session_tickets: "off"
nginx_ssl_stapling: "on"
nginx_ssl_stapling_verify: "on"

# SSL 证书路径
nginx_ssl_certificate_dir: "/etc/nginx/ssl"
nginx_ssl_dhparam_size: 2048
nginx_ssl_dhparam_file: "/etc/nginx/ssl/dhparam.pem"

# 自签名证书配置（用于测试）
nginx_ssl_self_signed_enabled: true
nginx_ssl_self_signed_country: "CN"
nginx_ssl_self_signed_state: "Beijing"
nginx_ssl_self_signed_locality: "Beijing"
nginx_ssl_self_signed_organization: "Example Company"
nginx_ssl_self_signed_organizational_unit: "IT"
nginx_ssl_self_signed_common_name: "example.com"
nginx_ssl_self_signed_email: "admin@example.com"
nginx_ssl_self_signed_days: 365

# ============================================================================
# 虚拟主机配置
# ============================================================================
nginx_vhosts:
  - name: "default"
    server_name: "_"
    listen_port: 80
    root: "/usr/share/nginx/html"
    index: "index.html index.htm"
    enabled: true
    access_log: "/var/log/nginx/default_access.log"
    error_log: "/var/log/nginx/default_error.log"
    
  - name: "example.com"
    server_name: "example.com www.example.com"
    listen_port: 80
    root: "/var/www/example.com"
    index: "index.html index.htm index.php"
    enabled: true
    access_log: "/var/log/nginx/example.com_access.log"
    error_log: "/var/log/nginx/example.com_error.log"
    # SSL 配置
    ssl_enabled: false
    ssl_certificate: "/etc/nginx/ssl/example.com.crt"
    ssl_certificate_key: "/etc/nginx/ssl/example.com.key"
    # PHP-FPM 配置
    php_enabled: false
    php_socket: "unix:/var/run/php/php-fpm.sock"
    # 重写规则
    rewrites: []
    # 自定义位置
    locations: []

# ============================================================================
# HTTPS 虚拟主机配置
# ============================================================================
nginx_https_vhosts:
  - name: "secure.example.com"
    server_name: "secure.example.com"
    listen_port: 443
    root: "/var/www/secure.example.com"
    index: "index.html index.htm"
    enabled: true
    access_log: "/var/log/nginx/secure.example.com_access.log"
    error_log: "/var/log/nginx/secure.example.com_error.log"
    # SSL 配置
    ssl_certificate: "/etc/nginx/ssl/secure.example.com.crt"
    ssl_certificate_key: "/etc/nginx/ssl/secure.example.com.key"
    # HTTP 到 HTTPS 重定向
    http_redirect: true
    # HSTS 配置
    hsts_enabled: true
    hsts_max_age: 31536000
    hsts_include_subdomains: true
    hsts_preload: true
    # 安全头部
    security_headers:
      X-Frame-Options: "SAMEORIGIN"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "no-referrer-when-downgrade"

# ============================================================================
# 反向代理配置
# ============================================================================
nginx_reverse_proxy_enabled: true

# 反向代理虚拟主机
nginx_reverse_proxy_vhosts:
  - name: "api.example.com"
    server_name: "api.example.com"
    listen_port: 80
    enabled: true
    access_log: "/var/log/nginx/api.example.com_access.log"
    error_log: "/var/log/nginx/api.example.com_error.log"
    # 代理目标
    proxy_pass: "http://backend_api"
    # 代理头部
    proxy_set_headers:
      Host: "$host"
      X-Real-IP: "$remote_addr"
      X-Forwarded-For: "$proxy_add_x_forwarded_for"
      X-Forwarded-Proto: "$scheme"
      X-Forwarded-Host: "$host"
      X-Forwarded-Port: "$server_port"
    # 代理超时
    proxy_connect_timeout: 60
    proxy_send_timeout: 60
    proxy_read_timeout: 60
    # 代理缓冲
    proxy_buffering: "on"
    proxy_buffer_size: "4k"
    proxy_buffers: "8 4k"
    # WebSocket 支持
    websocket_enabled: false

# 后端服务器配置
nginx_backend_servers:
  - name: "backend_api"
    servers:
      - address: "127.0.0.1:8080"
        weight: 1
        max_fails: 3
        fail_timeout: 30
      - address: "127.0.0.1:8081"
        weight: 1
        max_fails: 3
        fail_timeout: 30

# ============================================================================
# 负载均衡配置
# ============================================================================
nginx_load_balancer_enabled: true

# 负载均衡算法
nginx_load_balancer_method: "least_conn"  # 可选: round_robin, least_conn, ip_hash, hash

# 负载均衡器配置
nginx_load_balancers:
  - name: "web_backend"
    listen_port: 80
    server_name: "lb.example.com"
    enabled: true
    method: "least_conn"
    servers:
      - address: "192.168.1.101:80"
        weight: 1
        max_fails: 3
        fail_timeout: 30
        backup: false
      - address: "192.168.1.102:80"
        weight: 1
        max_fails: 3
        fail_timeout: 30
        backup: false
      - address: "192.168.1.103:80"
        weight: 1
        max_fails: 3
        fail_timeout: 30
        backup: true
    # 健康检查
    health_check:
      enabled: true
      uri: "/health"
      interval: 5
      fails: 3
      passes: 2
      timeout: 3
    # 会话保持
    sticky_sessions: false
    # SSL 配置
    ssl_enabled: false
    ssl_certificate: "/etc/nginx/ssl/lb.example.com.crt"
    ssl_certificate_key: "/etc/nginx/ssl/lb.example.com.key"

# ============================================================================
# 缓存配置
# ============================================================================
nginx_cache_enabled: true
nginx_cache_path: "/var/cache/nginx"
nginx_cache_keys_zone_name: "web_cache"
nginx_cache_keys_zone_size: "10m"
nginx_cache_max_size: "1g"
nginx_cache_inactive: "60m"
nginx_cache_valid_200: "1h"
nginx_cache_valid_301_302: "10m"
nginx_cache_valid_404: "1m"
nginx_cache_use_stale: "error timeout updating http_500 http_502 http_503 http_504"
nginx_cache_lock: "on"
nginx_cache_lock_timeout: "5s"
nginx_cache_bypass_cookie: "PHPSESSID"

# ============================================================================
# 限流配置
# ============================================================================
nginx_rate_limit_enabled: true
nginx_rate_limit_zone_name: "req_limit_per_ip"
nginx_rate_limit_zone_size: "10m"
nginx_rate_limit_rate: "10r/s"  # 每秒 10 个请求
nginx_rate_limit_burst: 20
nginx_rate_limit_nodelay: true

# 连接数限制
nginx_conn_limit_enabled: true
nginx_conn_limit_zone_name: "conn_limit_per_ip"
nginx_conn_limit_zone_size: "10m"
nginx_conn_limit_number: 10

# ============================================================================
# 日志配置
# ============================================================================
nginx_access_log_enabled: true
nginx_access_log_format: 'main'
nginx_access_log_format_definition: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for"'
nginx_error_log_level: "warn"  # 可选: debug, info, notice, warn, error, crit, alert, emerg

# 日志轮转配置
nginx_log_rotation_enabled: true
nginx_log_rotation_days: 7
nginx_log_rotation_count: 52

# ============================================================================
# 安全配置
# ============================================================================
nginx_security_enabled: true

# 隐藏版本号
nginx_server_tokens: "off"

# 访问控制
nginx_allow_ips: []
nginx_deny_ips: []

# 防止点击劫持
nginx_x_frame_options: "SAMEORIGIN"

# 防止 MIME 类型嗅探
nginx_x_content_type_options: "nosniff"

# XSS 保护
nginx_x_xss_protection: "1; mode=block"

# 内容安全策略（可选）
nginx_content_security_policy: ""

# 引用策略
nginx_referrer_policy: "no-referrer-when-downgrade"

# ============================================================================
# 状态监控配置
# ============================================================================
nginx_status_enabled: true
nginx_status_port: 80
nginx_status_path: "/nginx_status"
nginx_status_allowed_ips:
  - "127.0.0.1"
  - "::1"

# ============================================================================
# 防火墙配置
# ============================================================================
nginx_firewall_enabled: true
nginx_firewall_allowed_ports:
  - 80
  - 443

# ============================================================================
# 模块配置
# ============================================================================
nginx_modules_enabled: []
# 示例模块：
# - ngx_http_geoip_module
# - ngx_http_image_filter_module
# - ngx_http_perl_module

# ============================================================================
# 备份配置
# ============================================================================
nginx_backup_enabled: true
nginx_backup_dir: "/backup/nginx"
nginx_backup_retention_days: 7
nginx_backup_items:
  - "/etc/nginx"
  - "/usr/share/nginx/html"
  - "/var/www"

# ============================================================================
# 安全配置说明
# ⚠️ 安全警告：
# 1. 生产环境必须使用有效的 SSL 证书，不要使用自签名证书
# 2. 启用 HTTPS 并配置 HSTS 强制使用安全连接
# 3. 配置适当的防火墙规则，限制 Web 服务器访问来源
# 4. 定期更新 Nginx 版本以修复安全漏洞
# 5. 配置适当的日志记录和监控告警
# 6. 使用 Ansible Vault 加密敏感配置
# 7. 限流和防 DDoS 配置需根据实际业务调整
# 8. 反向代理环境需配置适当的头部信息防止信息泄露
# 9. 生产环境建议禁用状态页面或限制访问 IP
# 10. 定期备份配置文件和网站内容
# ============================================================================

# 通用配置
web_retry_count: 3
web_retry_delay: 5

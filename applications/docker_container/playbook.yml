---
- name: Docker 容器管理示例演示
  hosts: all
  gather_facts: false
  become: true
  vars_files:
    - vars/example_vars.yml
  
  tasks:
    - name: 确保 Docker 服务运行
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true
      when: docker_manage_service | bool

    - name: 部署 Nginx Web 服务器容器
      community.docker.docker_container:
        name: "{{ nginx_container_name }}"
        image: "{{ nginx_image }}:{{ nginx_version }}"
        state: started
        ports:
          - "{{ nginx_host_port }}:80"
          - "{{ nginx_ssl_port }}:443"
        volumes:
          - "{{ nginx_config_path }}:/etc/nginx/conf.d:ro"
          - "{{ nginx_content_path }}:/usr/share/nginx/html:ro"
          - "{{ nginx_log_path }}:/var/log/nginx"
        env:
          NGINX_HOST: "{{ nginx_server_name }}"
          NGINX_PORT: "80"
        restart_policy: "{{ nginx_restart_policy }}"
        networks:
          - "{{ docker_network_name }}"
        memory_limit: "{{ nginx_memory_limit }}"
      register: nginx_deployment
      when: deploy_nginx | bool

    - name: 部署 Redis 缓存服务容器
      community.docker.docker_container:
        name: "{{ redis_container_name }}"
        image: "{{ redis_image }}:{{ redis_version }}"
        state: started
        ports:
          - "{{ redis_host_port }}:6379"
        volumes:
          - "{{ redis_data_path }}:/data"
        command: redis-server --appendonly yes --requirepass "{{ redis_password }}"
        restart_policy: "{{ redis_restart_policy }}"
        networks:
          - "{{ docker_network_name }}"
        memory_limit: "{{ redis_memory_limit }}"
        user: "{{ redis_user }}"
      no_log: true
      register: redis_deployment
      when: deploy_redis | bool

    - name: 部署应用服务容器（持续部署示例）
      community.docker.docker_container:
        name: "{{ app_container_name }}"
        image: "{{ app_registry_url }}/{{ app_image_name }}:{{ app_version }}"
        state: started
        pull: true  # 确保拉取最新镜像
        ports:
          - "{{ app_host_port }}:{{ app_container_port }}"
        env:
          APP_ENV: "{{ app_environment }}"
          DATABASE_URL: "{{ app_database_url }}"
          REDIS_URL: "redis://{{ redis_container_name }}:6379"
          SECRET_KEY: "{{ app_secret_key }}"
          DEBUG: "{{ app_debug_mode }}"
        volumes:
          - "{{ app_log_path }}:/app/logs"
          - "{{ app_upload_path }}:/app/uploads"
        restart_policy: "{{ app_restart_policy }}"
        networks:
          - "{{ docker_network_name }}"
        memory_limit: "{{ app_memory_limit }}"
        cpus: "{{ app_cpu_limit }}"
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:{{ app_container_port }}/health"]
          interval: 30
          timeout: 10
          retries: 3
          start_period: 40
      no_log: true
      register: app_deployment
      when: deploy_app | bool

    - name: 等待应用容器健康检查通过
      ansible.builtin.wait_for:
        port: "{{ app_host_port }}"
        host: "{{ ansible_default_ipv4.address }}"
        delay: 10
        timeout: 120
      when: 
        - deploy_app | bool
        - app_deployment.changed

    - name: 验证容器运行状态
      community.docker.docker_container_info:
        name: "{{ item }}"
      register: container_status
      loop:
        - "{{ nginx_container_name }}"
        - "{{ redis_container_name }}"
        - "{{ app_container_name }}"
      when: 
        - (deploy_nginx | bool and item == nginx_container_name) or
          (deploy_redis | bool and item == redis_container_name) or
          (deploy_app | bool and item == app_container_name)

    - name: 显示容器状态信息
      ansible.builtin.debug:
        msg: |
          容器 {{ item.item }} 状态信息:
          - 运行状态: {{ item.container.State.Status }}
          - 镜像: {{ item.container.Config.Image }}
          - 创建时间: {{ item.container.Created }}
          - 端口映射: {{ item.container.NetworkSettings.Ports }}
      loop: "{{ container_status.results }}"
      when: container_status.results is defined

    - name: 创建容器网络（如果不存在）
      community.docker.docker_network:
        name: "{{ docker_network_name }}"
        state: present
        driver: bridge
      when: docker_create_network | bool


    - name: 仅在检查模式下预演变更
      ansible.builtin.debug:
        msg: "此任务运行在 check_mode 中，用于安全预演"
      check_mode: true
  handlers:
    - name: 重启 Nginx 容器
      community.docker.docker_container:
        name: "{{ nginx_container_name }}"
        state: restarted
      listen: restart nginx

    - name: 重启应用容器
      community.docker.docker_container:
        name: "{{ app_container_name }}"
        state: restarted
      listen: restart app

    - name: 清理停止的容器
      community.docker.docker_container:
        name: "{{ item }}"
        state: absent
      loop:
        - "{{ nginx_container_name }}"
        - "{{ redis_container_name }}"
        - "{{ app_container_name }}"
      listen: cleanup containers

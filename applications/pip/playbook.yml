---
- name: Python 包管理示例演示
  hosts: all
  gather_facts: true  # 需要获取操作系统信息用于包管理
  become: true
  vars_files:
    - vars/example_vars.yml
  
  tasks:
    - name: 确保系统 Python 和 pip 已安装
      ansible.builtin.package:
        name:
          - python3
          - python3-pip
          - python3-venv
        state: present
      when: install_system_python | bool

    - name: 创建项目虚拟环境
      ansible.builtin.pip:
        name: []
        virtualenv: "{{ project_venv_path }}"
        virtualenv_command: "{{ virtualenv_command }}"
        state: present
      when: create_venv | bool

    - name: 升级 pip 到最新版本
      ansible.builtin.pip:
        name: pip
        virtualenv: "{{ project_venv_path }}"
        state: latest
      when: upgrade_pip | bool

    - name: 安装 Web 应用核心依赖
      ansible.builtin.pip:
        name: "{{ web_dependencies }}"
        virtualenv: "{{ project_venv_path }}"
        state: present
      when: install_web_deps | bool
      register: web_deps_result

    - name: 安装数据库相关包
      ansible.builtin.pip:
        name: "{{ database_dependencies }}"
        virtualenv: "{{ project_venv_path }}"
        state: present
      when: install_database_deps | bool
      register: db_deps_result

    - name: 从 requirements.txt 安装项目依赖
      ansible.builtin.pip:
        requirements: "{{ requirements_file_path }}"
        virtualenv: "{{ project_venv_path }}"
        extra_args: "{{ pip_extra_args }}"
      when: 
        - install_from_requirements | bool
        - requirements_file_path is file
      register: requirements_result

    - name: 安装开发工具包
      ansible.builtin.pip:
        name: "{{ development_tools }}"
        virtualenv: "{{ dev_venv_path }}"
        state: present
      when: install_dev_tools | bool
      register: dev_tools_result

    - name: 从 Git 仓库安装开发版本包
      ansible.builtin.pip:
        name: "{{ git_packages }}"
        state: forcereinstall
        virtualenv: "{{ project_venv_path }}"
        extra_args: "--upgrade"
      when: install_git_packages | bool
      register: git_packages_result

    - name: 升级安全相关包到最新版本
      ansible.builtin.pip:
        name: "{{ security_packages }}"
        virtualenv: "{{ project_venv_path }}"
        state: latest
      when: upgrade_security_packages | bool
      register: security_upgrade_result

    - name: 清理不需要的开发包
      ansible.builtin.pip:
        name: "{{ cleanup_packages }}"
        virtualenv: "{{ dev_venv_path }}"
        state: absent
      when: cleanup_dev_packages | bool
      register: cleanup_result

    - name: 验证关键包安装状态
      ansible.builtin.pip:
        name: "{{ verification_packages }}"
        virtualenv: "{{ project_venv_path }}"
        state: present
      register: verification_result
      failed_when: verification_result.failed
      check_mode: "{{ pip_check_mode | default(false) }}"  # 可通过变量开启检查模式预演包验证

    - name: 显示包安装结果
      ansible.builtin.debug:
        msg: |
          包管理操作结果摘要:
          - Web 依赖安装: {{ '成功' if web_deps_result.changed else '无变更' }}
          - 数据库依赖安装: {{ '成功' if db_deps_result.changed else '无变更' }}
          - Requirements 安装: {{ '成功' if requirements_result.changed else '无变更' }}
          - 开发工具安装: {{ '成功' if dev_tools_result.changed else '无变更' }}
          - Git 包安装: {{ '成功' if git_packages_result.changed else '无变更' }}
          - 安全包升级: {{ '成功' if security_upgrade_result.changed else '无变更' }}
          - 清理操作: {{ '成功' if cleanup_result.changed else '无变更' }}
      when: show_results | bool

    - name: 检查虚拟环境包列表
      ansible.builtin.command: "{{ project_venv_path }}/bin/pip list"
      register: pip_list
      when: verify_installation | bool
      changed_when: false

    - name: 显示已安装的包
      ansible.builtin.debug:
        var: pip_list.stdout_lines
      when: 
        - verify_installation | bool
        - pip_list.stdout_lines is defined

    - name: 创建应用启动脚本
      ansible.builtin.template:
        src: app_start.j2
        dest: "{{ app_install_path }}/start.sh"
        mode: '0755'
      when: create_app_script | bool
      vars:
        python_path: "{{ project_venv_path }}/bin/python"

    - name: 设置应用目录权限
      ansible.builtin.file:
        path: "{{ app_install_path }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
        recurse: true
      when: set_permissions | bool

  handlers:
    - name: 重启应用服务
      ansible.builtin.service:
        name: "{{ app_service_name }}"
        state: restarted
      listen: restart app

    - name: 清理虚拟环境
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ project_venv_path }}"
        - "{{ dev_venv_path }}"
      listen: cleanup venvs
- name: GCP Compute Engine Dry Run 演练
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars/example_vars.yml

  tasks:
    - name: 显示即将验证的 GCE 规格
      ansible.builtin.debug:
        msg: |
          项目 {{ gcp_project }} / 区域 {{ gcp_zone }} Dry Run 计划：
          - 实例: {{ gcp_instance_name }} ({{ gcp_machine_type }})
          - 网络: {{ gcp_network }} / {{ gcp_subnetwork }}
          - 映像: {{ gcp_disk_image }}
          - 标签: {{ gcp_labels }}
          请确保 Service Account JSON 已通过 Vault 或 Secret Manager 保护。

    - name: 使用 google.cloud.gcp_compute_instance Dry Run（不会真实创建）
      google.cloud.gcp_compute_instance:
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        project: "{{ gcp_project }}"
        zone: "{{ gcp_zone }}"
        name: "{{ gcp_instance_name }}"
        machine_type: "{{ gcp_machine_type }}"
        disks:
          - auto_delete: true
            boot: true
            initialize_params:
              source_image: "{{ gcp_disk_image }}"
              disk_size_gb: {{ gcp_disk_size_gb }}
        network_interfaces:
          - network: "{{ gcp_network }}"
            subnetwork: "{{ gcp_subnetwork }}"
            access_configs: []
        tags:
          items: {{ gcp_tags }}
        labels: {{ gcp_labels }}
        state: present
      check_mode: true
      no_log: true

    - name: 输出 dry-run 建议
      ansible.builtin.debug:
        msg: |
          Dry Run 已完成；若需真实创建实例：
          1. 为 Service Account 附加 compute.instanceAdmin.v1 权限。
          2. 移除 playbook 中的 check_mode: true。
          3. ansible-playbook playbook.yml -e gcp_project={{ gcp_project }}。

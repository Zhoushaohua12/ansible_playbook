---
- name: command 模块安全执行示例演示
  hosts: all
  gather_facts: false
  become: false
  vars_files:
    - vars/example_vars.yml
  
  tasks:
    - name: 创建工作目录
      ansible.builtin.file:
        path: "{{ command_working_directory }}"
        state: directory
        mode: '0755'
    
    - name: 安全执行系统服务状态查询
      ansible.builtin.command: systemctl status {{ command_check_service }}
      register: service_status
      failed_when: false  # 服务不存在时不报错
      changed_when: false  # 仅查询状态，不修改系统
    
    - name: 显示服务状态信息
      ansible.builtin.debug:
        msg: |
          服务 {{ command_check_service }} 状态查询结果：
          返回码: {{ service_status.rc }}
          输出: {{ service_status.stdout_lines | default([]) }}
    
    - name: 使用 argv 参数安全执行 Python 版本查询
      ansible.builtin.command:
        argv:
          - /usr/bin/python3
          - --version
      register: python_version
      changed_when: false
      failed_when: false
    
    - name: 显示 Python 版本信息
      ansible.builtin.debug:
        msg: "Python 版本: {{ python_version.stdout | default('未安装') }}"
    
    - name: 幂等性演示 - 仅在初始化文件不存在时创建
      ansible.builtin.command: touch {{ command_init_file }}
      args:
        creates: "{{ command_init_file }}"  # 文件存在时跳过执行
      register: init_result
    
    - name: 显示初始化结果
      ansible.builtin.debug:
        msg: |
          应用初始化文件 {{ command_init_file }}
          创建状态: {{ '已创建' if init_result.changed else '已存在，跳过创建' }}
    
    - name: 安全执行磁盘使用情况查询
      ansible.builtin.command: du -sh {{ command_disk_usage }}
      register: disk_usage
      changed_when: false  # 仅查询信息
      failed_when: false   # 目录不存在时不报错
    
    - name: 显示磁盘使用情况
      ansible.builtin.debug:
        msg: "目录 {{ command_disk_usage }} 磁盘使用: {{ disk_usage.stdout | default('查询失败') }}"
    
    - name: 使用 command 模块创建应用配置（不使用 shell 特性）
      ansible.builtin.command:
        argv:
          - /bin/bash
          - -c
          - |
            cat > {{ command_config_file }} << EOF
            {
              "app_name": "{{ app_name }}",
              "version": "{{ app_version }}",
              "port": {{ app_port }},
              "created_by": "ansible_command_module"
            }
            EOF
      args:
        creates: "{{ command_config_file }}"
      register: config_result
    
    - name: 显示配置文件创建结果
      ansible.builtin.debug:
        msg: |
          配置文件 {{ command_config_file }}
          创建状态: {{ '已创建' if config_result.changed else '已存在' }}
    
    - name: 安全执行内存信息查询
      ansible.builtin.command: free -h
      register: memory_info
      changed_when: false
    
    - name: 显示内存使用情况
      ansible.builtin.debug:
        msg: |
          系统内存使用情况：
          {{ memory_info.stdout_lines | join('\n') }}
    
    - name: 清理演示 - 仅在备份文件存在时删除
      ansible.builtin.command: rm -f {{ command_backup_file }}
      args:
        removes: "{{ command_backup_file }}"  # 文件存在时才执行
      register: cleanup_result
      when: false  # 默认不执行清理，可手动启用
    
    - name: 显示清理结果
      ansible.builtin.debug:
        msg: |
          备份文件 {{ command_backup_file }}
          删除状态: {{ '已删除' if cleanup_result.changed | default(false) else '文件不存在，跳过删除' }}
      when: cleanup_result is defined

    - name: 仅在检查模式下预演变更
      ansible.builtin.debug:
        msg: "此任务运行在 check_mode 中，用于安全预演"
      check_mode: true

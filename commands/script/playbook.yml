---
- name: script æ¨¡å—æœ¬åœ°è„šæœ¬ä¼ è¾“æ‰§è¡Œç¤ºä¾‹æ¼”ç¤º
  hosts: all
  gather_facts: false
  become: false
  vars_files:
    - vars/example_vars.yml
  
  tasks:
    - name: åˆ›å»ºå·¥ä½œç›®å½•
      ansible.builtin.file:
        path: "{{ script_working_directory }}"
        state: directory
        mode: '0755'
    
    - name: ä¼ è¾“å¹¶æ‰§è¡Œåº”ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰
      ansible.builtin.script: files/example.sh {{ script_working_directory }} {{ app_name }}
      args:
        creates: "{{ script_working_directory }}/app.conf"  # å¹‚ç­‰æ€§æ§åˆ¶
      register: deploy_result
    
    - name: æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
      ansible.builtin.debug:
        msg: |
          åº”ç”¨éƒ¨ç½²è„šæœ¬æ‰§è¡Œç»“æœï¼š
          è¿”å›ç : {{ deploy_result.rc }}
          å˜æ›´çŠ¶æ€: {{ deploy_result.changed }}
          è¾“å‡ºå†…å®¹:
          {{ deploy_result.stdout_lines | default([]) | join('\n') }}
    
    - name: æ£€æŸ¥éƒ¨ç½²ç”Ÿæˆçš„æ–‡ä»¶
      ansible.builtin.stat:
        path: "{{ item }}"
      register: file_stats
      loop:
        - "{{ script_working_directory }}/app.conf"
        - "{{ script_working_directory }}/start_app.sh"
        - "{{ script_working_directory }}/health_check.sh"
        - "{{ script_working_directory }}/backup.sh"
    
    - name: æ˜¾ç¤ºæ–‡ä»¶çŠ¶æ€
      ansible.builtin.debug:
        msg: |
          æ–‡ä»¶: {{ item.item }}
          å­˜åœ¨: {{ item.stat.exists | default(false) }}
          å¤§å°: {{ item.stat.size | default(0) }} å­—èŠ‚
          æƒé™: {{ item.stat.mode | default('N/A') }}
      loop: "{{ file_stats.results }}"
    
    - name: è¯»å–ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å†…å®¹
      ansible.builtin.slurp:
        src: "{{ script_working_directory }}/app.conf"
      register: config_content
      when: file_stats.results[0].stat.exists | default(false)
    
    - name: æ˜¾ç¤ºé…ç½®æ–‡ä»¶å†…å®¹
      ansible.builtin.debug:
        msg: |
          åº”ç”¨é…ç½®æ–‡ä»¶å†…å®¹ï¼š
          {{ config_content.content | b64decode }}
      when: config_content is defined
    
    - name: æ‰§è¡Œåº”ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¼”ç¤ºè„šæœ¬è°ƒç”¨ï¼‰
      ansible.builtin.script: "{{ script_working_directory }}/start_app.sh"
      args:
        chdir: "{{ script_working_directory }}"
      register: start_result
      when: file_stats.results[1].stat.exists | default(false)
    
    - name: æ˜¾ç¤ºå¯åŠ¨ç»“æœ
      ansible.builtin.debug:
        msg: |
          åº”ç”¨å¯åŠ¨ç»“æœï¼š
          {{ start_result.stdout_lines | default([]) | join('\n') }}
      when: start_result is defined
    
    - name: æ‰§è¡Œå¥åº·æ£€æŸ¥è„šæœ¬
      ansible.builtin.script: "{{ script_working_directory }}/health_check.sh"
      args:
        chdir: "{{ script_working_directory }}"
      register: health_result
      when: file_stats.results[2].stat.exists | default(false)
    
    - name: æ˜¾ç¤ºå¥åº·æ£€æŸ¥ç»“æœ
      ansible.builtin.debug:
        msg: |
          åº”ç”¨å¥åº·æ£€æŸ¥ç»“æœï¼š
          {{ health_result.stdout_lines | default([]) | join('\n') }}
      when: health_result is defined
    
    - name: æ‰§è¡Œå¤‡ä»½è„šæœ¬ï¼ˆæ¼”ç¤ºå¤‡ä»½åŠŸèƒ½ï¼‰
      ansible.builtin.script: "{{ script_working_directory }}/backup.sh"
      args:
        chdir: "{{ script_working_directory }}"
      register: backup_result
      when: file_stats.results[3].stat.exists | default(false)
    
    - name: æ˜¾ç¤ºå¤‡ä»½ç»“æœ
      ansible.builtin.debug:
        msg: |
          å¤‡ä»½æ‰§è¡Œç»“æœï¼š
          {{ backup_result.stdout_lines | default([]) | join('\n') }}
      when: backup_result is defined
    
    - name: æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
      ansible.builtin.find:
        paths: "{{ script_working_directory }}/backups"
        patterns: "backup_*.tar.gz"
      register: backup_files
      when: backup_result is defined
    
    - name: æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶ä¿¡æ¯
      ansible.builtin.debug:
        msg: |
          æ‰¾åˆ°çš„å¤‡ä»½æ–‡ä»¶ï¼š
          {% for file in backup_files.files %}
          - {{ file.path }} ({{ file.size }} å­—èŠ‚, ä¿®æ”¹æ—¶é—´: {{ file.mtime }})
          {% endfor %}
      when: backup_files is defined and backup_files.files | length > 0
    
    - name: æ¸…ç†æ¼”ç¤º - åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
      ansible.builtin.file:
        path: "{{ script_working_directory }}"
        state: absent
      register: cleanup_result
      when: false  # é»˜è®¤ç¦ç”¨æ¸…ç†ï¼Œå¯æ‰‹åŠ¨å¯ç”¨
    
    - name: æ˜¾ç¤ºæ¸…ç†ç»“æœ
      ansible.builtin.debug:
        msg: |
          ä¸´æ—¶ç›®å½•æ¸…ç†çŠ¶æ€: {{ 'å·²åˆ é™¤' if cleanup_result.changed else 'æœªåˆ é™¤' }}
      when: cleanup_result is defined
    
    - name: script æ¨¡å—ä½¿ç”¨æ€»ç»“
      ansible.builtin.debug:
        msg: |
          ğŸ“ script æ¨¡å—ä½¿ç”¨æ€»ç»“ï¼š
          
          1. è„šæœ¬ä¼ è¾“ï¼šè‡ªåŠ¨å°†æœ¬åœ°è„šæœ¬æ–‡ä»¶ä¼ è¾“åˆ°è¿œç¨‹ä¸»æœºå¹¶æ‰§è¡Œ
          2. å¹‚ç­‰æ€§ï¼šé€šè¿‡ creates/removes å‚æ•°å®ç°å¹‚ç­‰æ€§æ§åˆ¶
          3. å‚æ•°ä¼ é€’ï¼šå¯åœ¨è„šæœ¬è·¯å¾„åç›´æ¥ä¼ é€’å‘½ä»¤è¡Œå‚æ•°
          4. é”™è¯¯å¤„ç†ï¼šè„šæœ¬åº”åŒ…å«é€‚å½“çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼ˆset -eï¼‰
          5. æ—¥å¿—è®°å½•ï¼šå»ºè®®è„šæœ¬æä¾›è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
          6. æ–‡ä»¶ç»„ç»‡ï¼šè„šæœ¬æ–‡ä»¶æ”¾åœ¨ files/ ç›®å½•ä¸‹ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶
          
          ä¼˜åŠ¿ï¼š
          - æ”¯æŒå¤æ‚è„šæœ¬é€»è¾‘
          - è„šæœ¬å¯ç‹¬ç«‹æµ‹è¯•å’Œç»´æŠ¤
          - æ”¯æŒç‰ˆæœ¬æ§åˆ¶å’Œä»£ç å®¡æŸ¥
          - å¯é‡ç”¨ç°æœ‰è„šæœ¬èµ„æº

    - name: ä»…åœ¨æ£€æŸ¥æ¨¡å¼ä¸‹é¢„æ¼”å˜æ›´
      ansible.builtin.debug:
        msg: "æ­¤ä»»åŠ¡è¿è¡Œåœ¨ check_mode ä¸­ï¼Œç”¨äºå®‰å…¨é¢„æ¼”"
      check_mode: true

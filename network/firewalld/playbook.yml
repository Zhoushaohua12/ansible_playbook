---
- name: firewalld 防火墙规则管理示例
  hosts: all
  gather_facts: false
  become: true
  vars_files:
    - vars/example_vars.yml
  
  tasks:
    # 确保 firewalld 服务运行
    - name: 启动 firewalld 服务
      ansible.builtin.systemd:
        name: firewalld
        state: started
        enabled: true
        daemon_reload: true
    
    # 验证 firewalld 状态
    - name: 验证 firewalld 状态
      ansible.builtin.command: firewall-cmd --state
      register: firewalld_state
      changed_when: false
    
    - name: 显示 firewalld 状态
      ansible.builtin.debug:
        msg: "firewalld 状态: {{ firewalld_state.stdout }}"
    
    # ========== 批量开放 Web 服务端口 ==========
    - name: 在 public zone 批量开放 Web 服务端口
      community.general.firewalld:
        service: "{{ item }}"
        zone: "{{ firewalld_web_zone }}"
        state: enabled
        permanent: true
        immediate: true
      loop: "{{ firewalld_web_services }}"
      when: firewalld_state.stdout == "running"
    
    # ========== 开放应用服务端口 ==========
    - name: 在 internal zone 开放应用服务端口
      community.general.firewalld:
        port: "{{ firewalld_app_port }}/{{ firewalld_app_protocol }}"
        zone: "{{ firewalld_app_zone }}"
        state: enabled
        permanent: true
        immediate: true
      when: firewalld_state.stdout == "running"
    
    # ========== 开放数据库访问（限制源 IP） ==========
    - name: 在 internal zone 开放 MySQL（限制源 IP）
      community.general.firewalld:
        port: "{{ firewalld_db_port }}/tcp"
        zone: "{{ firewalld_db_zone }}"
        state: enabled
        permanent: true
        immediate: true
      when: firewalld_state.stdout == "running"
    
    # ========== 配置 SSH 访问策略 ==========
    - name: 在 internal zone 开放 SSH 端口
      community.general.firewalld:
        service: ssh
        zone: "{{ firewalld_ssh_zone }}"
        state: enabled
        permanent: true
        immediate: true
      when: firewalld_state.stdout == "running"
    
    # ========== 配置 DNS 服务 ==========
    - name: 在 public zone 开放 DNS 服务
      community.general.firewalld:
        service: dns
        zone: "{{ firewalld_dns_zone }}"
        state: enabled
        permanent: true
        immediate: true
      when: firewalld_state.stdout == "running" and firewalld_enable_dns
    
    # ========== 验证规则配置 ==========
    - name: 获取 public zone 当前规则
      ansible.builtin.command: firewall-cmd --zone=public --list-all
      register: firewalld_public_rules
      changed_when: false
    
    - name: 显示 public zone 规则
      ansible.builtin.debug:
        msg: "{{ firewalld_public_rules.stdout_lines }}"
    
    - name: 获取 internal zone 当前规则
      ansible.builtin.command: firewall-cmd --zone=internal --list-all
      register: firewalld_internal_rules
      changed_when: false
    
    - name: 显示 internal zone 规则
      ansible.builtin.debug:
        msg: "{{ firewalld_internal_rules.stdout_lines }}"
    
    # ========== 备份规则配置 ==========
    - name: 将运行时配置保存为永久配置
      ansible.builtin.command: firewall-cmd --runtime-to-permanent
      register: firewall_backup
      changed_when: "'success' in firewall_backup.stdout or firewall_backup.rc == 0"

    - name: 仅在检查模式下预演变更
      ansible.builtin.debug:
        msg: "此任务运行在 check_mode 中，用于安全预演"
      check_mode: true

# audit.rules - 审计规则文件
# 此文件由 Ansible 模板生成，请勿手动修改

# ========== 文件监控规则 ==========
# 监控关键系统文件
{% for rule in audit_rules if rule.type == 'file_watch %}
-w {{ rule.path }} -p {{ rule.permissions }} -k {{ rule.key }}
{% endfor %}

# ========== 系统调用监控规则 ==========
# 监控进程创建相关的系统调用
{% for rule in audit_rules if rule.type == 'syscall' %}
-a always,exit -F arch=b64 {% for syscall in rule.syscalls %}-S {{ syscall }} {% endfor %}-k {{ rule.key }}
{% endfor %}

# ========== 用户监控规则 ==========
# 监控特权用户操作
{% for rule in audit_rules if rule.type == 'user' %}
-a always,exit -F uid={{ rule.uid }} -k {{ rule.key }}
{% endfor %}

# ========== 默认安全规则 ==========
# 监控身份认证相关文件
-w /etc/passwd -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/sudoers -p wa -k sudo

# 监控登录相关文件
-w /var/log/lastlog -p wa -k logins
-w /var/log/faillog -p wa -k logins
-w /var/log/tallylog -p wa -k logins
-w /var/log/secure -p wa -k logins
-w /var/log/auth.log -p wa -k logins

# 监控网络配置
-w /etc/hosts -p wa -k network
-w /etc/resolv.conf -p wa -k network
-w /etc/network/ -p wa -k network

# 监控系统时间
-w /etc/localtime -p wa -k time
-w /etc/timezone -p wa -k time

# ========== 进程监控规则 ==========
# 监控进程创建和执行
-a always,exit -F arch=b64 -S execve -k process_creation
-a always,exit -F arch=b32 -S execve -k process_creation
-a always,exit -F arch=b64 -S fork -k process_creation
-a always,exit -F arch=b32 -S fork -k process_creation
-a always,exit -F arch=b64 -S clone -k process_creation
-a always,exit -F arch=b32 -S clone -k process_creation

# ========== 权限提升监控 ==========
# 监控权限提升相关的系统调用
-a always,exit -F arch=b64 -S setuid -k privilege_escalation
-a always,exit -F arch=b64 -S setgid -k privilege_escalation
-a always,exit -F arch=b64 -S setreuid -k privilege_escalation
-a always,exit -F arch=b64 -S setregid -k privilege_escalation

# ========== 文件系统监控 ==========
# 监控文件系统操作
-a always,exit -F arch=b64 -S openat -k file_access
-a always,exit -F arch=b64 -S open -k file_access
-a always,exit -F arch=b64 -S creat -k file_access
-a always,exit -F arch=b64 -S link -k file_access
-a always,exit -F arch=b64 -S symlink -k file_access
-a always,exit -F arch=b64 -S unlink -k file_access
-a always,exit -F arch=b64 -S rename -k file_access

# ========== 网络连接监控 ==========
# 监控网络连接建立
-a always,exit -F arch=b64 -S connect -k network_connection
-a always,exit -F arch=b64 -S bind -k network_connection
-a always,exit -F arch=b64 -S listen -k network_connection
-a always,exit -F arch=b64 -S accept -k network_connection

# ========== 特权命令监控 ==========
# 监控特权命令执行
-a always,exit -F euid=0 -S execve -k privileged_commands
-a always,exit -F egid=0 -S execve -k privileged_commands

# ========== 模块加载监控 ==========
# 监控内核模块加载
-a always,exit -F arch=b64 -S init_module -k module_load
-a always,exit -F arch=b64 -S delete_module -k module_load
-a always,exit -F arch=b64 -S finit_module -k module_load

# ========== 合规性规则（根据配置启用） ==========
{% if compliance_rules.pci_dss.enabled | default(false) %}
# PCI DSS 合规性审计规则
-w /etc/passwd -p wa -k pci_dss_identity
-w /etc/shadow -p wa -k pci_dss_identity
-a always,exit -F uid=0 -k pci_dss_root_commands
{% endif %}

{% if compliance_rules.hipaa.enabled | default(false) %}
# HIPAA 合规性审计规则
-w /var/log/audit/ -p wa -k hipaa_audit_trail
-a always,exit -F uid=0 -k hipaa_privileged_access
{% endif %}

# ========== 排除规则 ==========
# 排除不重要的系统调用以减少噪音
-a never,exit -F arch=b64 -S socket -F addr=127.0.0.1 -k local_socket
-a never,exit -F arch=b64 -S socket -F addr=::1 -k local_socket

# 排除系统进程的某些操作
-a never,exit -F pid=1 -k init_process
-a never,exit -F pid=2 -k kthreadd

# ========== 结束标记 ==========
# 文件结束，不要在此行之后添加规则
-d -e
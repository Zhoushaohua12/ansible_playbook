---
- name: kernel_tuning 内核调优配置示例演示
  hosts: localhost
  gather_facts: true
  check_mode: true
  vars_files:
    - vars/example_vars.yml

  tasks:
    # ========== 网络参数优化 ==========
    - name: 优化网络栈参数
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-network-tuning.conf
        reload: yes
      become: yes
      loop:
        - { name: "net.core.rmem_max", value: "{{ network_settings.rmem_max }}" }
        - { name: "net.core.wmem_max", value: "{{ network_settings.wmem_max }}" }
        - { name: "net.core.netdev_max_backlog", value: "{{ network_settings.netdev_max_backlog }}" }
        - { name: "net.ipv4.tcp_rmem", value: "{{ network_settings.tcp_rmem }}" }
        - { name: "net.ipv4.tcp_wmem", value: "{{ network_settings.tcp_wmem }}" }
        - { name: "net.ipv4.tcp_congestion_control", value: "{{ network_settings.congestion_control }}" }
      register: network_tuning_result

    - name: 显示网络参数优化结果
      ansible.builtin.debug:
        msg: |
          网络栈参数优化：
          接收缓冲区最大值: {{ network_settings.rmem_max }}
          发送缓冲区最大值: {{ network_settings.wmem_max }}
          网络设备积压队列: {{ network_settings.netdev_max_backlog }}
          TCP 拥塞控制算法: {{ network_settings.congestion_control }}
          配置变更数: {{ network_tuning_result.results | selectattr('changed') | list | length }}

    # ========== 内存管理优化 ==========
    - name: 优化内存管理参数
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-memory-tuning.conf
        reload: yes
      become: yes
      loop:
        - { name: "vm.swappiness", value: "{{ memory_settings.swappiness }}" }
        - { name: "vm.dirty_ratio", value: "{{ memory_settings.dirty_ratio }}" }
        - { name: "vm.dirty_background_ratio", value: "{{ memory_settings.dirty_background_ratio }}" }
        - { name: "vm.vfs_cache_pressure", value: "{{ memory_settings.vfs_cache_pressure }}" }
        - { name: "vm.min_free_kbytes", value: "{{ memory_settings.min_free_kbytes }}" }
      register: memory_tuning_result

    - name: 显示内存管理优化结果
      ansible.builtin.debug:
        msg: |
          内存管理参数优化：
          交换分区使用倾向: {{ memory_settings.swappiness }}
          脏页面比例: {{ memory_settings.dirty_ratio }}%
          后台脏页面比例: {{ memory_settings.dirty_background_ratio }}%
          VFS 缓存压力: {{ memory_settings.vfs_cache_pressure }}
          最小空闲内存: {{ memory_settings.min_free_kbytes }}KB
          配置变更数: {{ memory_tuning_result.results | selectattr('changed') | list | length }}

    # ========== 安全加固参数 ==========
    - name: 配置安全加固参数
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-security-hardening.conf
        reload: yes
      become: yes
      loop:
        - { name: "net.ipv4.ip_forward", value: "{{ security_settings.ip_forward }}" }
        - { name: "net.ipv4.conf.all.send_redirects", value: "{{ security_settings.send_redirects }}" }
        - { name: "net.ipv4.conf.all.accept_source_route", value: "{{ security_settings.accept_source_route }}" }
        - { name: "net.ipv4.conf.all.accept_redirects", value: "{{ security_settings.accept_redirects }}" }
        - { name: "net.ipv4.conf.all.secure_redirects", value: "{{ security_settings.secure_redirects }}" }
        - { name: "net.ipv4.tcp_syncookies", value: "{{ security_settings.tcp_syncookies }}" }
        - { name: "net.ipv4.icmp_echo_ignore_broadcasts", value: "{{ security_settings.icmp_echo_ignore_broadcasts }}" }
      register: security_hardening_result

    - name: 显示安全加固配置结果
      ansible.builtin.debug:
        msg: |
          安全加固参数配置：
          IP转发: {{ security_settings.ip_forward }}
          发送重定向: {{ security_settings.send_redirects }}
          接受源路由: {{ security_settings.accept_source_route }}
          接受重定向: {{ security_settings.accept_redirects }}
          TCP SYN cookies: {{ security_settings.tcp_syncookies }}
          ICMP广播忽略: {{ security_settings.icmp_echo_ignore_broadcasts }}
          配置变更数: {{ security_hardening_result.results | selectattr('changed') | list | length }}

    # ========== 文件系统优化 ==========
    - name: 优化文件系统参数
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-filesystem-tuning.conf
        reload: yes
      become: yes
      loop:
        - { name: "fs.file-max", value: "{{ filesystem_settings.file_max }}" }
        - { name: "fs.inotify.max_user_watches", value: "{{ filesystem_settings.inotify_max_user_watches }}" }
        - { name: "fs.inotify.max_user_instances", value: "{{ filesystem_settings.inotify_max_user_instances }}" }
        - { name: "fs.aio-max-nr", value: "{{ filesystem_settings.aio_max_nr }}" }
      register: filesystem_tuning_result

    - name: 显示文件系统优化结果
      ansible.builtin.debug:
        msg: |
          文件系统参数优化：
          最大文件描述符: {{ filesystem_settings.file_max }}
          inotify 监控数: {{ filesystem_settings.inotify_max_user_watches }}
          inotify 实例数: {{ filesystem_settings.inotify_max_user_instances }}
          异步I/O最大数: {{ filesystem_settings.aio_max_nr }}
          配置变更数: {{ filesystem_tuning_result.results | selectattr('changed') | list | length }}

    # ========== 进程和资源限制 ==========
    - name: 配置进程和资源限制
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-process-limits.conf
        reload: yes
      become: yes
      loop:
        - { name: "kernel.pid_max", value: "{{ process_settings.pid_max }}" }
        - { name: "kernel.threads-max", value: "{{ process_settings.threads_max }}" }
        - { name: "kernel.sem", value: "{{ process_settings.sem }}" }
        - { name: "kernel.shmmax", value: "{{ process_settings.shmmax }}" }
        - { name: "kernel.shmall", value: "{{ process_settings.shmall }}" }
      register: process_limits_result

    - name: 显示进程和资源限制配置结果
      ansible.builtin.debug:
        msg: |
          进程和资源限制配置：
          最大PID: {{ process_settings.pid_max }}
          最大线程数: {{ process_settings.threads_max }}
          信号量参数: {{ process_settings.sem }}
          最大共享内存: {{ process_settings.shmmax }}
          共享内存页数: {{ process_settings.shmall }}
          配置变更数: {{ process_limits_result.results | selectattr('changed') | list | length }}

    # ========== 内核参数验证 ==========
    - name: 验证内核参数设置
      ansible.builtin.shell: |
        echo "=== 内核参数验证 ==="
        
        # 验证网络参数
        echo "网络参数验证："
        sysctl net.core.rmem_max 2>/dev/null || echo "参数不存在"
        sysctl net.ipv4.tcp_congestion_control 2>/dev/null || echo "参数不存在"
        
        # 验证内存参数
        echo "内存参数验证："
        sysctl vm.swappiness 2>/dev/null || echo "参数不存在"
        sysctl vm.dirty_ratio 2>/dev/null || echo "参数不存在"
        
        # 验证安全参数
        echo "安全参数验证："
        sysctl net.ipv4.ip_forward 2>/dev/null || echo "参数不存在"
        sysctl net.ipv4.tcp_syncookies 2>/dev/null || echo "参数不存在"
        
        # 验证文件系统参数
        echo "文件系统参数验证："
        sysctl fs.file-max 2>/dev/null || echo "参数不存在"
        sysctl fs.inotify.max_user_watches 2>/dev/null || echo "参数不存在"
      register: kernel_params_validation
      become: yes
      changed_when: false

    - name: 显示内核参数验证结果
      ansible.builtin.debug:
        msg: "{{ kernel_params_validation.stdout_lines }}"

    # ========== 系统资源状态检查 ==========
    - name: 检查系统资源状态
      ansible.builtin.shell: |
        echo "=== 系统资源状态检查 ==="
        
        # 内存状态
        echo "内存使用情况："
        free -h | head -4
        
        # 文件描述符使用情况
        echo ""
        echo "文件描述符使用情况："
        echo "系统限制: $(cat /proc/sys/fs/file-max)"
        echo "当前使用: $(cat /proc/sys/fs/file-nr | awk '{print $1}')"
        echo "已分配: $(cat /proc/sys/fs/file-nr | awk '{print $2}')"
        
        # 进程状态
        echo ""
        echo "进程状态："
        echo "当前进程数: $(ps aux | wc -l)"
        echo "最大PID限制: $(cat /proc/sys/kernel/pid_max)"
        
        # 网络状态
        echo ""
        echo "网络连接状态："
        echo "TCP连接数: $(cat /proc/net/tcp | wc -l)"
        echo "UDP连接数: $(cat /proc/net/udp | wc -l)"
      register: system_resource_status
      changed_when: false

    - name: 显示系统资源状态
      ansible.builtin.debug:
        msg: "{{ system_resource_status.stdout_lines }}"

    # ========== 性能基准测试（演示） ==========
    - name: 执行性能基准测试（演示模式）
      ansible.builtin.shell: |
        echo "=== 性能基准测试（演示） ==="
        
        # 网络性能测试（简单测试）
        echo "网络性能测试："
        if command -v ss &> /dev/null; then
          echo "当前TCP连接数: $(ss -t | wc -l)"
          echo "监听端口数: $(ss -l | wc -l)"
        else
          echo "ss 命令不可用，跳过网络测试"
        fi
        
        # 内存性能测试
        echo ""
        echo "内存性能测试："
        echo "交换分区使用: $(free | grep Swap | awk '{print $3"/"$2}')"
        echo "缓存使用: $(free -h | grep Mem | awk '{print $6}')"
        
        # I/O 性能测试（简单检查）
        echo ""
        echo "I/O 性能测试："
        if command -v iostat &> /dev/null; then
          iostat -x 1 1 | tail -n +4 | head -5
        else
          echo "iostat 命令不可用，跳过 I/O 测试"
        fi
        
        # 系统负载测试
        echo ""
        echo "系统负载："
        uptime
      register: performance_benchmark
      changed_when: false

    - name: 显示性能基准测试结果
      ansible.builtin.debug:
        msg: "{{ performance_benchmark.stdout_lines }}"

    # ========== 调优效果评估 ==========
    - name: 评估调优效果
      ansible.builtin.shell: |
        echo "=== 内核调优效果评估 ==="
        
        # 检查关键参数是否生效
        echo "关键参数检查："
        
        # 网络参数
        echo "TCP 拥塞控制: $(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo '未知')"
        echo "最大接收缓冲区: $(sysctl -n net.core.rmem_max 2>/dev/null || echo '未知')"
        
        # 内存参数
        echo "交换分区倾向: $(sysctl -n vm.swappiness 2>/dev/null || echo '未知')"
        echo "脏页面比例: $(sysctl -n vm.dirty_ratio 2>/dev/null || echo '未知')%"
        
        # 安全参数
        echo "IP转发状态: $(sysctl -n net.ipv4.ip_forward 2>/dev/null || echo '未知')"
        echo "SYN cookies: $(sysctl -n net.ipv4.tcp_syncookies 2>/dev/null || echo '未知')"
        
        # 文件系统参数
        echo "最大文件描述符: $(sysctl -n fs.file-max 2>/dev/null || echo '未知')"
        echo "inotify 监控数: $(sysctl -n fs.inotify.max_user_watches 2>/dev/null || echo '未知')"
        
        # 系统整体状态
        echo ""
        echo "系统整体状态："
        echo "系统负载: $(uptime | awk -F'load average:' '{print $2}')"
        echo "内存使用率: $(free | grep Mem | awk '{printf("%.1f%%"), $3/$2 * 100.0}')"
        echo "运行时间: $(uptime -p 2>/dev/null || uptime)"
      register: tuning_effectiveness
      changed_when: false

    - name: 显示调优效果评估结果
      ansible.builtin.debug:
        msg: "{{ tuning_effectiveness.stdout_lines }}"

    # ========== 内核参数说明 ==========
    - name: 显示内核参数说明
      ansible.builtin.debug:
        msg: |
          内核调优参数说明：
          
          1. 网络栈优化：
             - net.core.rmem_max: TCP 接收缓冲区最大值
             - net.core.wmem_max: TCP 发送缓冲区最大值
             - net.ipv4.tcp_congestion_control: TCP 拥塞控制算法
             - net.ipv4.tcp_syncookies: SYN flood 攻击防护
          
          2. 内存管理优化：
             - vm.swappiness: 交换分区使用倾向 (0-100)
             - vm.dirty_ratio: 脏页面占内存最大比例
             - vm.vfs_cache_pressure: VFS 缓存回收倾向
             - vm.min_free_kbytes: 系统保留最小空闲内存
          
          3. 安全加固：
             - net.ipv4.ip_forward: IP 转发功能
             - net.ipv4.conf.all.accept_source_route: 接受源路由包
             - net.ipv4.conf.all.accept_redirects: 接受 ICMP 重定向
             - net.ipv4.icmp_echo_ignore_broadcasts: 忽略 ICMP 广播
          
          4. 文件系统优化：
             - fs.file-max: 系统最大文件描述符数
             - fs.inotify.max_user_watches: inotify 监控文件数
             - fs.aio-max-nr: 异步 I/O 最大请求数
          
          5. 进程和资源限制：
             - kernel.pid_max: 最大 PID 值
             - kernel.threads-max: 最大线程数
             - kernel.sem: System V 信号量参数
             - kernel.shmmax: 最大共享内存段

    # ========== 内核调优完成总结 ==========
    - name: 内核调优配置完成总结
      ansible.builtin.debug:
        msg: |
          内核调优配置已完成：
          
          1. 网络栈优化：
             - TCP/IP 参数：已优化
             - 缓冲区设置：已调整
             - 拥塞控制：{{ network_settings.congestion_control }}
             - 配置变更数: {{ network_tuning_result.results | selectattr('changed') | list | length }}
          
          2. 内存管理优化：
             - 交换分区策略：已配置
             - 页面缓存优化：已应用
             - 内存压力控制：已设置
             - 配置变更数: {{ memory_tuning_result.results | selectattr('changed') | list | length }}
          
          3. 安全加固：
             - 网络安全参数：已配置
             - 防护机制：已启用
             - 转发控制：已禁用
             - 配置变更数: {{ security_hardening_result.results | selectattr('changed') | list | length }}
          
          4. 文件系统优化：
             - 文件描述符限制：已调整
             - inotify 参数：已优化
             - 异步 I/O 设置：已配置
             - 配置变更数: {{ filesystem_tuning_result.results | selectattr('changed') | list | length }}
          
          5. 进程和资源限制：
             - PID 和线程限制：已设置
             - 共享内存参数：已配置
             - 信号量设置：已调整
             - 配置变更数: {{ process_limits_result.results | selectattr('changed') | list | length }}
          
          重要提醒：
          - 内核参数变更可能影响系统稳定性
          - 建议在测试环境充分验证后再应用到生产环境
          - 保留原始配置以便快速回滚
          - 监控系统性能指标评估调优效果
          
          常用内核管理命令：
          - sysctl -a：查看所有内核参数
          - sysctl -w param=value：临时设置参数
          - sysctl -p /etc/sysctl.conf：加载配置文件
          - sysctl --system：加载所有配置文件
          - cat /proc/sys/param：查看当前参数值

  handlers:
    - name: 重新加载 sysctl 配置
      ansible.builtin.shell: |
        sysctl --system
      become: yes
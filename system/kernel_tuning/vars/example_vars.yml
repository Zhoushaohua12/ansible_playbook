# ⚠️ 本文件仅为示例，占位符必须使用 Ansible Vault 或环境变量替换

# ========== 网络栈优化配置 ==========
# TCP/IP 网络参数调优
network_settings:
  # 核心网络缓冲区设置
  rmem_max: 134217728          # 接收缓冲区最大值 (128MB)
  wmem_max: 134217728          # 发送缓冲区最大值 (128MB)
  netdev_max_backlog: 5000     # 网络设备积压队列长度
  
  # TCP 缓冲区设置 (min, default, max)
  tcp_rmem: "4096 87380 134217728"
  tcp_wmem: "4096 65536 134217728"
  
  # TCP 连接管理
  tcp_congestion_control: "bbr"  # 拥塞控制算法 (bbr/cubic/reno)
  tcp_fin_timeout: 60            # FIN 超时时间 (秒)
  tcp_keepalive_time: 1200       # keepalive 时间 (秒)
  tcp_keepalive_probes: 9        # keepalive 探测次数
  tcp_keepalive_intvl: 75        # keepalive 探测间隔 (秒)
  
  # TCP 连接队列
  tcp_max_syn_backlog: 65536     # SYN 队列长度
  tcp_syncookies: 1              # SYN cookies 保护
  tcp_max_orphans: 262144        # 最大孤立 socket 数
  
  # 网络连接优化
  net.ipv4.ip_local_port_range: "1024 65535"  # 本地端口范围
  net.core.somaxconn: 65535      # 监听队列最大长度

# ========== 内存管理优化配置 ==========
# 虚拟内存和页面缓存调优
memory_settings:
  # 交换分区使用策略
  swappiness: 10                 # 交换分区使用倾向 (0-100)
  
  # 脏页面管理
  dirty_ratio: 15                # 脏页面占内存最大比例 (%)
  dirty_background_ratio: 5      # 后台写入脏页面比例 (%)
  dirty_writeback_centisecs: 500 # 脏页面写入间隔 (厘秒)
  dirty_expire_centisecs: 3000   # 脏页面过期时间 (厘秒)
  
  # 缓存管理
  vfs_cache_pressure: 50         # VFS 缓存回收倾向 (0-200)
  min_free_kbytes: 65536         # 系统保留最小空闲内存 (KB)
  
  # 内存回收策略
  zone_reclaim_mode: 0           # 内存回收模式
  page-cluster: 3                # 页面回收集群大小

# ========== 安全加固配置 ==========
# 网络安全参数配置
security_settings:
  # IP 转发和路由
  ip_forward: 0                  # 禁用 IP 转发
  send_redirects: 0              # 禁用发送重定向
  accept_source_route: 0         # 拒绝源路由包
  accept_redirects: 0            # 拒绝 ICMP 重定向
  secure_redirects: 1            # 只接受安全重定向
  
  # SYN flood 防护
  tcp_syncookies: 1              # 启用 SYN cookies
  tcp_synack_retries: 5          # SYN-ACK 重试次数
  tcp_max_syn_backlog: 4096      # SYN 队列长度
  
  # ICMP 控制
  icmp_echo_ignore_broadcasts: 1 # 忽略 ICMP 广播
  icmp_ignore_bogus_error_responses: 1  # 忽略错误 ICMP
  
  # 网络接口安全
  all.rp_filter: 1               # 启用反向路径过滤
  default.rp_filter: 1           # 默认接口反向路径过滤
  
  # 日志记录
  log_martians: 1                # 记录异常数据包

# ========== 文件系统优化配置 ==========
# 文件描述符和 inotify 调优
filesystem_settings:
  # 文件描述符限制
  file_max: 1048576              # 系统最大文件描述符数
  file-nr: "1024 4096 1048576"   # 当前文件描述符统计
  
  # inotify 监控
  inotify_max_user_watches: 524288    # 用户监控文件数
  inotify_max_user_instances: 256     # 用户 inotify 实例数
  inotify_max_queued_events: 16384    # 队列事件数
  
  # 异步 I/O
  aio_max_nr: 1048576            # 异步 I/O 最大请求数
  aio_nr: 0                      # 当前异步 I/O 请求数
  
  # 文件系统缓存
  dirty_background_ratio: 5      # 后台脏页面比例
  dirty_ratio: 10                # 最大脏页面比例

# ========== 进程和资源限制配置 ==========
# 进程、线程和共享内存调优
process_settings:
  # 进程限制
  pid_max: 4194303               # 最大 PID 值
  threads_max: 262144            # 最大线程数
  
  # System V 信号量
  sem: "250 32000 100 128"       # SEMMSL SEMMNS SEMOPM SEMMNI
  
  # 共享内存
  shmmax: 68719476736            # 最大共享内存段 (64GB)
  shmall: 4194304                # 共享内存页数
  shmmni: 4096                   # 共享内存段最大数
  
  # 消息队列
  msgmax: 65536                  # 最大消息大小
  msgmnb: 65536                  # 消息队列最大大小
  msgmni: 1024                   # 消息队列最大数
  
  # 其他进程参数
  sched_migration_cost_ns: 50000 # 进程迁移成本
  sched_nr_migrate: 8            # 迁移进程数

# ========== 应用场景优化配置 ==========
# 不同应用场景的优化参数
application_profiles:
  # Web 服务器优化
  web_server:
    enabled: false
    network:
      net.core.somaxconn: 65535
      net.ipv4.tcp_max_syn_backlog: 65536
      net.ipv4.tcp_fin_timeout: 30
    filesystem:
      fs.file-max: 2097152
      fs.inotify.max_user_watches: 524288
  
  # 数据库服务器优化
  database_server:
    enabled: false
    memory:
      vm.swappiness: 1
      vm.dirty_ratio: 10
      vm.dirty_background_ratio: 5
    process:
      kernel.sem: "500 32000 100 142"
      kernel.shmmax: 137438953472  # 128GB
  
  # 高性能计算优化
  hpc_server:
    enabled: false
    network:
      net.core.rmem_max: 268435456
      net.core.wmem_max: 268435456
      net.ipv4.tcp_congestion_control: "bbr"
    process:
      kernel.pid_max: 4194303
      kernel.threads-max: 524288
  
  # 虚拟化宿主机优化
  virtualization_host:
    enabled: false
    memory:
      vm.swappiness: 30
      vm.dirty_ratio: 20
      vm.dirty_background_ratio: 10
    filesystem:
      fs.aio-max-nr: 1048576
      fs.inotify.max_user_instances: 1024

# ========== 监控和诊断配置 ==========
# 内核参数监控配置
monitoring:
  # 性能监控参数
  performance_monitoring:
    enabled: true
    collect_interval: 60         # 收集间隔 (秒)
    metrics:
      - memory_usage
      - network_throughput
      - file_descriptor_usage
      - process_count
  
  # 告警阈值
  alert_thresholds:
    memory_usage: 80             # 内存使用率告警阈值 (%)
    file_descriptor_usage: 85    # 文件描述符使用率告警阈值 (%)
    network_connections: 10000   # 网络连接数告警阈值
    process_count: 5000          # 进程数告警阈值
  
  # 日志级别
  log_level: "info"

# ========== 回滚和恢复配置 ==========
# 配置回滚参数
rollback:
  # 自动备份
  auto_backup: true
  backup_dir: "/etc/sysctl.d/backup"
  
  # 回滚策略
  max_backup_files: 10           # 最大备份数量
  backup_retention_days: 30      # 备份保留天数
  
  # 紧急恢复
  emergency_restore: true
  safe_mode_params:
    - "vm.swappiness=60"
    - "net.ipv4.ip_forward=0"
    - "fs.file-max=8192"

# ========== ⚠️ 重要安全提示 ==========
# ⚠️  内核参数调优警告：
# 1. 错误的内核参数可能导致系统不稳定或无法启动
# 2. 在生产环境部署前必须在测试环境充分验证
# 3. 保留原始配置文件以便快速回滚
# 4. 某些参数可能对特定硬件或应用不兼容

# ⚠️  性能影响注意：
# 1. 内核参数调优效果因硬件和应用而异
# 2. 需要根据实际工作负载调整参数值
# 3. 监控系统性能指标评估调优效果
# 4. 避免过度优化导致系统不稳定

# ⚠️  安全配置风险：
# 1. 过于严格的安全参数可能影响系统功能
# 2. 某些安全参数可能影响网络性能
# 3. 平衡安全性和可用性
# 4. 定期评估和更新安全参数配置

# ⚠️  版本兼容性：
# 1. 不同内核版本的参数支持可能不同
# 2. 某些参数在特定内核版本中已废弃
# 3. 新内核版本可能引入新的优化参数
# 4. 系统升级时需要验证参数兼容性

# ⚠️  在生产环境使用前的建议：
# - 使用 --check 模式预览变更：ansible-playbook playbook.yml --check
# - 在测试环境充分验证所有参数的功能和性能影响
# - 创建系统快照或完整备份
# - 准备参数回滚脚本和恢复流程
# - 建立性能监控和告警机制
# - 定期审查和更新内核参数配置
# - 考虑使用配置管理工具进行版本控制
# - 建立参数变更的审批和记录流程
---
- name: pam_hardening PAM 安全加固配置示例演示
  hosts: localhost
  gather_facts: true
  check_mode: true
  vars_files:
    - vars/example_vars.yml

  tasks:
    # ========== 基础 PAM 模块安装 ==========
    - name: 安装 PAM 相关软件包
      ansible.builtin.package:
        name:
          - pam
          - libpwquality
          - cracklib
        state: present
      become: yes
      register: pam_packages_result
      check_mode: false

    - name: 显示 PAM 软件包安装结果
      ansible.builtin.debug:
        msg: |
          PAM 相关软件包安装状态：
          结果: {{ pam_packages_result }}
          此任务未启用 check_mode，确保必要的软件包已安装

    # ========== 密码策略配置 ==========
    - name: 配置密码质量策略（pam_pwquality）
      community.general.pamd:
        name: system-auth
        type: password
        control: requisite
        module_path: pam_pwquality.so
        module_arguments: "try_first_pass local_users_only retry=3 authtok_type="
        state: updated
        create: yes
      become: yes
      register: pam_pwquality_result

    - name: 显示密码质量策略配置结果
      ansible.builtin.debug:
        msg: |
          pam_pwquality 模块配置：
          服务: system-auth
          类型: password
          控制: requisite
          结果: {{ pam_pwquality_result }}

    # ========== 账户锁定机制配置 ==========
    - name: 配置账户锁定预认证（pam_faillock）
      community.general.pamd:
        name: system-auth
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: "preauth silent deny={{ account_lockout.max_attempts }} unlock_time={{ account_lockout.unlock_time }}"
        state: updated
        create: yes
      become: yes
      register: pam_preauth_result

    - name: 配置账户锁定后认证（pam_faillock）
      community.general.pamd:
        name: system-auth
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: "authfail deny={{ account_lockout.max_attempts }} unlock_time={{ account_lockout.unlock_time }} root_unlock_time={{ account_lockout.root_unlock_time }}"
        state: updated
        create: yes
      become: yes
      register: pam_authfail_result

    - name: 配置账户锁定成功认证（pam_faillock）
      community.general.pamd:
        name: system-auth
        type: auth
        control: sufficient
        module_path: pam_faillock.so
        module_arguments: "authsucc sufficient"
        state: updated
        create: yes
      become: yes
      register: pam_authsucc_result

    - name: 显示账户锁定配置结果
      ansible.builtin.debug:
        msg: |
          pam_faillock 账户锁定配置：
          最大失败次数: {{ account_lockout.max_attempts }}
          锁定时间: {{ account_lockout.unlock_time }}秒
          root解锁时间: {{ account_lockout.root_unlock_time }}秒
          配置状态: {{ pam_preauth_result.changed and pam_authfail_result.changed and pam_authsucc_result.changed }}

    # ========== 密码历史记录配置 ==========
    - name: 配置密码历史记录（pam_unix）
      community.general.pamd:
        name: system-auth
        type: password
        control: sufficient
        module_path: pam_unix.so
        module_arguments: "sha512 shadow nullok try_first_pass use_authtok remember={{ password_policies.history_count }}"
        state: updated
        create: yes
      become: yes
      register: pam_history_result

    - name: 显示密码历史记录配置结果
      ansible.builtin.debug:
        msg: |
          密码历史记录配置：
          历史记录数: {{ password_policies.history_count }}
          配置状态: {{ pam_history_result }}

    # ========== 会话超时配置 ==========
    - name: 配置会话超时（pam_limits）
      community.general.pam_limits:
        domain: "*"
        limit_type: soft
        limit_item: "{{ session_limits.timeout_type }}"
        value: "{{ session_limits.timeout_value }}"
      become: yes
      register: session_timeout_result

    - name: 显示会话超时配置结果
      ansible.builtin.debug:
        msg: |
          会话超时配置：
          限制类型: {{ session_limits.timeout_type }}
          限制值: {{ session_limits.timeout_value }}
          配置状态: {{ session_timeout_result }}

    # ========== 并发连接限制 ==========
    - name: 配置并发连接限制（pam_limits）
      community.general.pam_limits:
        domain: "*"
        limit_type: hard
        limit_item: maxlogins
        value: "{{ session_limits.max_concurrent }}"
      become: yes
      register: concurrent_limit_result

    - name: 显示并发连接限制配置结果
      ansible.builtin.debug:
        msg: |
          并发连接限制：
          最大登录数: {{ session_limits.max_concurrent }}
          配置状态: {{ concurrent_limit_result }}

    # ========== 登录警告横幅配置 ==========
    - name: 配置本地登录警告横幅
      ansible.builtin.copy:
        content: "{{ vault_pam_warning_banner }}"
        dest: /etc/issue
        backup: yes
        mode: '0644'
      become: yes
      no_log: true
      register: local_banner_result
      when: enable_login_banner | default(false)

    - name: 配置 SSH 登录警告横幅
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Banner'
        line: "Banner /etc/issue"
        backup: yes
      become: yes
      notify: 重启 SSH 服务
      register: ssh_banner_result
      when: enable_login_banner | default(false)

    - name: 显示登录横幅配置结果
      ansible.builtin.debug:
        msg: |
          登录警告横幅配置：
          启用状态: {{ enable_login_banner | default(false) }}
          本地登录横幅: {{ local_banner_result.changed | default(false) }}
          SSH登录横幅: {{ ssh_banner_result.changed | default(false) }}
          注意：横幅内容已启用 no_log 保护
      when: enable_login_banner | default(false)

    # ========== PAM 配置文件验证 ==========
    - name: 验证 PAM 配置文件语法
      ansible.builtin.shell: |
        echo "=== PAM 配置文件验证 ==="
        
        # 检查 system-auth 配置
        if [ -f /etc/pam.d/system-auth ]; then
          echo "✓ system-auth 配置文件存在"
          echo "配置行数: $(wc -l < /etc/pam.d/system-auth)"
        else
          echo "✗ system-auth 配置文件不存在"
        fi
        
        # 检查 pam_pwquality 配置
        if [ -f /etc/security/pwquality.conf ]; then
          echo "✓ pwquality.conf 配置文件存在"
        else
          echo "✗ pwquality.conf 配置文件不存在"
        fi
        
        # 检查 limits 配置
        if [ -f /etc/security/limits.conf ]; then
          echo "✓ limits.conf 配置文件存在"
        else
          echo "✗ limits.conf 配置文件不存在"
        fi
      register: pam_config_validation
      become: yes
      changed_when: false

    - name: 显示 PAM 配置验证结果
      ansible.builtin.debug:
        msg: "{{ pam_config_validation.stdout_lines }}"

    # ========== 密码策略文件配置 ==========
    - name: 配置密码质量策略文件
      ansible.builtin.lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^{{ item.key }}'
        line: '{{ item.key }} = {{ item.value }}'
        create: yes
        backup: yes
      become: yes
      loop:
        - { key: 'minlen', value: "{{ password_policies.min_length }}" }
        - { key: 'dcredit', value: "{{ password_policies.require_digit }}" }
        - { key: 'ucredit', value: "{{ password_policies.require_upper }}" }
        - { key: 'lcredit', value: "{{ password_policies.require_lower }}" }
        - { key: 'ocredit', value: "{{ password_policies.require_special }}" }
        - { key: 'minclass', value: "{{ password_policies.min_char_classes }}" }
        - { key: 'maxrepeat', value: "{{ password_policies.max_repeat }}" }
        - { key: 'difok', value: "{{ password_policies.min_diff_chars }}" }
      register: pwquality_config_result

    - name: 显示密码质量策略配置结果
      ansible.builtin.debug:
        msg: |
          密码质量策略文件配置：
          最小长度: {{ password_policies.min_length }}
          要求数字: {{ password_policies.require_digit }}
          要求大写: {{ password_policies.require_upper }}
          要求小写: {{ password_policies.require_lower }}
          要求特殊字符: {{ password_policies.require_special }}
          最小字符类别: {{ password_policies.min_char_classes }}
          配置变更: {{ pwquality_config_result.results | selectattr('changed') | list | length }}项

    # ========== PAM 模块状态检查 ==========
    - name: 检查 PAM 模块可用性
      ansible.builtin.shell: |
        echo "=== PAM 模块可用性检查 ==="
        
        # 检查关键 PAM 模块
        modules=("pam_unix.so" "pam_pwquality.so" "pam_faillock.so" "pam_limits.so")
        
        for module in "${modules[@]}"; do
          if find /lib*/security/ -name "$module" 2>/dev/null | grep -q .; then
            echo "✓ $module 已安装"
          else
            echo "✗ $module 未找到"
          fi
        done
      register: pam_modules_check
      become: yes
      changed_when: false

    - name: 显示 PAM 模块检查结果
      ansible.builtin.debug:
        msg: "{{ pam_modules_check.stdout_lines }}"

    # ========== 安全配置测试 ==========
    - name: 测试 PAM 配置（演示模式）
      ansible.builtin.shell: |
        echo "=== PAM 配置测试（演示） ==="
        
        # 测试 pam-config 工具（如果可用）
        if command -v pam-config &> /dev/null; then
          echo "pam-config 工具可用，开始测试..."
          pam-config --test 2>/dev/null || echo "pam-config 测试完成（可能有警告）"
        else
          echo "pam-config 工具不可用，跳过测试"
        fi
        
        # 检查 PAM 配置文件语法
        echo "检查 PAM 配置文件语法..."
        for config in /etc/pam.d/*; do
          if [ -f "$config" ]; then
            # 简单的语法检查
            if grep -q "^[^#].*\.so" "$config"; then
              echo "✓ $config 包含 PAM 模块配置"
            fi
          fi
        done
      register: pam_config_test
      become: yes
      changed_when: false

    - name: 显示 PAM 配置测试结果
      ansible.builtin.debug:
        msg: "{{ pam_config_test.stdout_lines }}"

    # ========== PAM 安全策略说明 ==========
    - name: 显示 PAM 安全策略说明
      ansible.builtin.debug:
        msg: |
          PAM 安全加固策略说明：
          
          1. 密码复杂度策略：
             - 最小长度: {{ password_policies.min_length }}个字符
             - 必须包含: 数字、大写字母、小写字母、特殊字符
             - 最少字符类别: {{ password_policies.min_char_classes }}种
             - 密码历史: 记录最近{{ password_policies.history_count }}个密码
          
          2. 账户锁定策略：
             - 最大失败次数: {{ account_lockout.max_attempts }}次
             - 普通用户锁定时间: {{ account_lockout.unlock_time }}秒
             - root用户锁定时间: {{ account_lockout.root_unlock_time }}秒
             - 自动解锁机制: 已配置
          
          3. 会话限制策略：
             - 会话超时: {{ session_limits.timeout_value }}{{ session_limits.timeout_type }}
             - 最大并发连接: {{ session_limits.max_concurrent }}个
             - 资源限制: 已配置
          
          4. 安全提示横幅：
             - 登录警告: {{ enable_login_banner | default(false) | ternary('已启用', '未启用') }}
             - 法律声明: 已部署
             - SSH横幅: 已配置

    # ========== PAM 配置完成总结 ==========
    - name: PAM 安全加固配置完成总结
      ansible.builtin.debug:
        msg: |
          PAM 安全加固配置已完成：
          
          1. 基础配置：
             - PAM 软件包：已安装
             - 配置文件：已更新
             - 模块配置：已应用
          
          2. 安全策略：
             - 密码复杂度：已配置
             - 账户锁定：已启用
             - 会话限制：已设置
             - 登录横幅：{{ enable_login_banner | default(false) | ternary('已部署', '未部署') }}
          
          3. 安全特性：
             - 敏感信息保护：已启用 no_log
             - 配置文件备份：已创建
             - 权限控制：已设置
          
          4. 监控与维护：
             - 配置验证：已完成
             - 模块检查：已通过
             - 测试验证：已执行
          
          重要安全提醒：
          - PAM 配置错误可能导致无法登录系统
          - 在生产环境部署前必须充分测试
          - 保留配置备份和恢复机制
          - 定期审查和更新安全策略
          
          常用 PAM 管理命令：
          - faillock --user username：查看用户锁定状态
          - chage -l username：查看用户密码策略
          - pam-config --test：测试 PAM 配置
          - service sshd restart：重启 SSH 服务应用横幅

  handlers:
    - name: 重启 SSH 服务
      ansible.builtin.systemd:
        name: sshd
        state: restarted
      become: yes
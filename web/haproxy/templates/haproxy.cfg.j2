# HAProxy 配置文件模板
# 由 Ansible 自动生成，请勿直接编辑
# Generated by Ansible - Do not edit manually

# ===== 全局配置 =====
global
    # 进程配置
    maxconn {{ haproxy_maxconn }}
    
    # 日志配置
    log {{ haproxy_log_facility }} {{ haproxy_log_level }}
    
    # 用户与安全配置
    user {{ haproxy_user }}
    group {{ haproxy_group }}
    chroot {{ haproxy_chroot }}
    
    # 守护进程配置
    daemon
    
    # SSL 全局配置
    ssl-default-bind-ciphers {{ haproxy_ssl_ciphers }}
    ssl-default-bind-options ssl-min-ver TLSv1.2
    
    # 其他配置
    pidfile /var/run/haproxy.pid
    stats socket /var/run/haproxy.sock mode 660 level admin
    
# ===== 默认配置 =====
defaults
    # 协议模式
    mode http
    
    # 日志格式
    log global
    option httplog
    option dontlognull
    
    # 错误处理
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http
    
    # 超时配置
    timeout connect {{ haproxy_timeout_connect }}s
    timeout client {{ haproxy_timeout_client }}s
    timeout server {{ haproxy_timeout_server }}s
    timeout http-keep-alive {{ haproxy_timeout_http_keep_alive }}ms
    
    # HTTP 配置
    option http-server-close
    option http-use-proxy-header
    option forwardfor except 127.0.0.0/8

# ===== 前端配置（HTTP）=====
frontend http_front
    # 绑定地址和端口
    bind {{ haproxy_listen_address }}:{{ haproxy_listen_port }}
    
    # 前端名称和日志
    option httplog
    
    # 默认后端
    default_backend http_back

{% if haproxy_ssl_enabled %}
# ===== 前端配置（HTTPS）=====
frontend https_front
    # 绑定 HTTPS 端口（带 SSL 证书）
    bind {{ haproxy_listen_address }}:{{ haproxy_https_listen_port }} ssl crt {{ haproxy_ssl_certificate_path }}
    
    # SSL 选项
    ssl-session-cache shared:SSL:10m
    ssl-session-timeout 10m
    
    # HSTS 头
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains" if { ssl_fc }
    
    # 默认后端
    default_backend http_back
{% endif %}

# ===== 后端配置 =====
backend http_back
    # 平衡策略
    balance {{ haproxy_balance_strategy }}
    
    # HTTP 健康检查
    option httpchk GET / HTTP/1.1\r\nHost:\ localhost
    
{% if haproxy_session_persistence_type == 'cookie' %}
    # 会话保持（基于 Cookie）
    cookie {{ haproxy_session_cookie_name }} insert indirect nocache
{% endif %}

    # 后端服务器定义
{% for server in haproxy_backend_servers %}
    server {{ server.name }} {{ server.host }}:{{ server.port }} {{ server.check }} inter {{ haproxy_health_check_interval }} timeout {{ haproxy_health_check_timeout }} rise {{ haproxy_health_check_rise }} fall {{ haproxy_health_check_fall }}{% if haproxy_session_persistence_type == 'cookie' %} cookie {{ server.name }}{% endif %}{% if server.weight and server.weight != '1' %} weight {{ server.weight }}{% endif %}

{% endfor %}

{% if haproxy_stats_enabled %}
# ===== 统计页面配置 =====
frontend stats_front
    bind {{ haproxy_listen_address }}:{{ haproxy_stats_port }}
    stats enable
    stats uri {{ haproxy_stats_uri }}
    stats show-legends
    stats show-node
    stats admin if { true }
    stats refresh 30s
{% endif %}

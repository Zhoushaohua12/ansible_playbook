# Apache 静态站点配置: {{ static_domain }}
# 由 Ansible 自动生成

{% if ssl_enabled | default(false) %}
# HTTP 虚拟主机（重定向到 HTTPS）
<VirtualHost *:80>
    ServerName {{ static_domain }}
    Redirect permanent / https://{{ static_domain }}/
    
    ErrorLog ${APACHE_LOG_DIR}/{{ static_domain }}_error.log
    CustomLog ${APACHE_LOG_DIR}/{{ static_domain }}_access.log combined
</VirtualHost>

# HTTPS 静态站点虚拟主机
<VirtualHost *:443>
    ServerName {{ static_domain }}
    ServerAdmin webmaster@{{ static_domain }}
    
    # SSL 配置
    SSLEngine on
    SSLCertificateFile {{ ssl_certificate_path }}
    SSLCertificateKeyFile {{ ssl_certificate_key_path }}
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on
    
    # HSTS 安全头
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
{% else %}
# HTTP 静态站点虚拟主机
<VirtualHost *:80>
    ServerName {{ static_domain }}
    ServerAdmin webmaster@{{ static_domain }}
{% endif %}
    
    # 网站根目录
    DocumentRoot {{ web_root }}
    
    # 默认首页文件
    DirectoryIndex {{ static_index_files | default(['index.html', 'index.htm']) | join(' ') }}
    
    # 日志配置
    ErrorLog ${APACHE_LOG_DIR}/{{ static_domain }}_error.log
    CustomLog ${APACHE_LOG_DIR}/{{ static_domain }}_access.log combined
    LogLevel {{ log_level | default('warn') }}
    
    # 目录配置
    <Directory {{ web_root }}>
        # 禁止目录浏览，允许符号链接
        Options -Indexes +FollowSymLinks
        
        # 允许 .htaccess 覆盖配置
        AllowOverride {{ allow_override | default('All') }}
        
        # 访问控制
        Require all granted
    </Directory>
    
    {% if static_cache_enabled | default(true) %}
    # 启用缓存模块
    <IfModule mod_expires.c>
        ExpiresActive On
        
        # HTML 文件短期缓存
        ExpiresByType text/html "access plus 1 hour"
        
        # CSS 和 JavaScript
        ExpiresByType text/css "access plus {{ static_cache_duration | default('30 days') }}"
        ExpiresByType application/javascript "access plus {{ static_cache_duration | default('30 days') }}"
        ExpiresByType text/javascript "access plus {{ static_cache_duration | default('30 days') }}"
        
        # 图片
        ExpiresByType image/jpeg "access plus {{ static_cache_duration | default('30 days') }}"
        ExpiresByType image/png "access plus {{ static_cache_duration | default('30 days') }}"
        ExpiresByType image/gif "access plus {{ static_cache_duration | default('30 days') }}"
        ExpiresByType image/svg+xml "access plus {{ static_cache_duration | default('30 days') }}"
        ExpiresByType image/x-icon "access plus {{ static_cache_duration | default('30 days') }}"
        ExpiresByType image/webp "access plus {{ static_cache_duration | default('30 days') }}"
        
        # 字体
        ExpiresByType font/ttf "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
        
        # 默认缓存时间
        ExpiresDefault "access plus 1 week"
    </IfModule>
    
    # Cache-Control 头
    <IfModule mod_headers.c>
        <FilesMatch "\.(html|htm)$">
            Header set Cache-Control "public, must-revalidate, max-age=3600"
        </FilesMatch>
        
        <FilesMatch "\.(css|js)$">
            Header set Cache-Control "public, immutable, max-age=2592000"
        </FilesMatch>
        
        <FilesMatch "\.(jpg|jpeg|png|gif|ico|svg|webp)$">
            Header set Cache-Control "public, immutable, max-age=2592000"
        </FilesMatch>
    </IfModule>
    {% endif %}
    
    # Gzip 压缩
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/x-javascript
        AddOutputFilterByType DEFLATE application/json application/xml application/rss+xml
        AddOutputFilterByType DEFLATE image/svg+xml
        
        # 禁止对已压缩格式再次压缩
        SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|zip|gz|bz2)$ no-gzip
    </IfModule>
    
    # 安全响应头
    <IfModule mod_headers.c>
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
    </IfModule>
    
    # 禁止访问隐藏文件
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # 禁止访问备份和临时文件
    <FilesMatch "\.(bak|config|sql|old|swp|tmp)$">
        Require all denied
    </FilesMatch>
    
    # 自定义错误页面
    ErrorDocument 404 /404.html
    ErrorDocument 500 /50x.html
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
